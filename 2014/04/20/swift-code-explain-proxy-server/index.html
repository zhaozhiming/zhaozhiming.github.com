<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>swift源码详解（二）——proxy/server.py - Hacker and Geeker&#39;s Way</title>
    <meta name="author" content="">
    
	<meta name="description" content="swift源码详解"> <!-- TODO: truncate -->
	<meta name="keywords" content="swift">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="Hacker and Geeker&#39;s Way" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='/stylesheets/font.css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/font.css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/font.css?family=Amethysta+One' rel='stylesheet' type='text/css'>
	  <script src="/javascripts/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-100485541-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


<meta name="generator" content="Hexo 6.3.0"></head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Hacker and Geeker&#39;s Way
    </div>
</h1>
<span class="subtitle"></span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a target="_blank" rel="noopener" href="https://github.com/zhaozhiming" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a target="_blank" rel="noopener" href="http://www.twitter.com/kingzzm" class="twitter" title="Twitter"></a>
  </li>
  
  
  <!-- LinkedIn -->
  <li>
  <a target="_blank" rel="noopener" href="http://www.linkedin.com/in/zhaozhiming" class="linkedin" title="LinkedIn"></a>
  </li>
  
  
  
  
  
  <!-- Stackoverflow -->
  <li>
  <a target="_blank" rel="noopener" href="http://stackoverflow.com/users/1954315/zhaozhiming" class="stackoverflow" title="Stackoverflow"></a>
  </li>
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    <li><a href="/about/index.html">About</a></li>
    
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="https://zhaozhiming.github.io" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>


<div id="toload">
<!-- begin toload -->
    <div id="content">
        <div class="inner">
<article class="post">
	<h2 class="title">swift源码详解（二）——proxy/server.py</h2>
    <div class="meta">
        <div class="date">Published on: <time datetime="2014-04-20T12:52:00.000Z" itemprop="datePublished">4月 20, 2014</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/swift/">swift</a>
</div>
    </div>
	<div class="entry-content"><h2 id="回swift代码结构目录"><a href="#回swift代码结构目录" class="headerlink" title="回swift代码结构目录"></a><a href="http://zhaozhiming.github.io/2014/04/19/swift-code-explain-total/">回swift代码结构目录</a></h2><h3 id="int方法"><a href="#int方法" class="headerlink" title="int方法"></a>int方法</h3><span id="more"></span>  
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, conf, memcache=<span class="literal">None</span>, logger=<span class="literal">None</span>, account_ring=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             container_ring=<span class="literal">None</span>, object_ring=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> conf <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        conf = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> logger <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.logger = get_logger(conf, log_route=<span class="string">&#x27;proxy-server&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="variable language_">self</span>.logger = logger</span><br><span class="line">    swift_dir = conf.get(<span class="string">&#x27;swift_dir&#x27;</span>, <span class="string">&#x27;/etc/swift&#x27;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.node_timeout = <span class="built_in">int</span>(conf.get(<span class="string">&#x27;node_timeout&#x27;</span>, <span class="number">10</span>))</span><br><span class="line">    <span class="variable language_">self</span>.recoverable_node_timeout = <span class="built_in">int</span>(</span><br><span class="line">        conf.get(<span class="string">&#x27;recoverable_node_timeout&#x27;</span>, <span class="variable language_">self</span>.node_timeout))</span><br><span class="line">    <span class="variable language_">self</span>.conn_timeout = <span class="built_in">float</span>(conf.get(<span class="string">&#x27;conn_timeout&#x27;</span>, <span class="number">0.5</span>))</span><br><span class="line">    <span class="variable language_">self</span>.client_timeout = <span class="built_in">int</span>(conf.get(<span class="string">&#x27;client_timeout&#x27;</span>, <span class="number">60</span>))</span><br><span class="line">    <span class="variable language_">self</span>.put_queue_depth = <span class="built_in">int</span>(conf.get(<span class="string">&#x27;put_queue_depth&#x27;</span>, <span class="number">10</span>))</span><br><span class="line">    <span class="variable language_">self</span>.object_chunk_size = <span class="built_in">int</span>(conf.get(<span class="string">&#x27;object_chunk_size&#x27;</span>, <span class="number">65536</span>))</span><br><span class="line">    <span class="variable language_">self</span>.client_chunk_size = <span class="built_in">int</span>(conf.get(<span class="string">&#x27;client_chunk_size&#x27;</span>, <span class="number">65536</span>))</span><br><span class="line">    <span class="variable language_">self</span>.trans_id_suffix = conf.get(<span class="string">&#x27;trans_id_suffix&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.post_quorum_timeout = <span class="built_in">float</span>(conf.get(<span class="string">&#x27;post_quorum_timeout&#x27;</span>, <span class="number">0.5</span>))</span><br><span class="line">    <span class="variable language_">self</span>.error_suppression_interval = \</span><br><span class="line">        <span class="built_in">int</span>(conf.get(<span class="string">&#x27;error_suppression_interval&#x27;</span>, <span class="number">60</span>))</span><br><span class="line">    <span class="variable language_">self</span>.error_suppression_limit = \</span><br><span class="line">        <span class="built_in">int</span>(conf.get(<span class="string">&#x27;error_suppression_limit&#x27;</span>, <span class="number">10</span>))</span><br><span class="line">    <span class="variable language_">self</span>.recheck_container_existence = \</span><br><span class="line">        <span class="built_in">int</span>(conf.get(<span class="string">&#x27;recheck_container_existence&#x27;</span>, <span class="number">60</span>))</span><br><span class="line">    <span class="variable language_">self</span>.recheck_account_existence = \</span><br><span class="line">        <span class="built_in">int</span>(conf.get(<span class="string">&#x27;recheck_account_existence&#x27;</span>, <span class="number">60</span>))</span><br><span class="line">    <span class="variable language_">self</span>.allow_account_management = \</span><br><span class="line">        config_true_value(conf.get(<span class="string">&#x27;allow_account_management&#x27;</span>, <span class="string">&#x27;no&#x27;</span>))</span><br><span class="line">    <span class="variable language_">self</span>.object_post_as_copy = \</span><br><span class="line">        config_true_value(conf.get(<span class="string">&#x27;object_post_as_copy&#x27;</span>, <span class="string">&#x27;true&#x27;</span>))</span><br><span class="line">    <span class="variable language_">self</span>.object_ring = object_ring <span class="keyword">or</span> Ring(swift_dir, ring_name=<span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.container_ring = container_ring <span class="keyword">or</span> Ring(swift_dir,</span><br><span class="line">                                                 ring_name=<span class="string">&#x27;container&#x27;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.account_ring = account_ring <span class="keyword">or</span> Ring(swift_dir,</span><br><span class="line">                                             ring_name=<span class="string">&#x27;account&#x27;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.memcache = memcache</span><br><span class="line">    mimetypes.init(mimetypes.knownfiles +</span><br><span class="line">                   [os.path.join(swift_dir, <span class="string">&#x27;mime.types&#x27;</span>)])</span><br><span class="line">    <span class="variable language_">self</span>.account_autocreate = \</span><br><span class="line">        config_true_value(conf.get(<span class="string">&#x27;account_autocreate&#x27;</span>, <span class="string">&#x27;no&#x27;</span>))</span><br><span class="line">    <span class="variable language_">self</span>.expiring_objects_account = \</span><br><span class="line">        (conf.get(<span class="string">&#x27;auto_create_account_prefix&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span>) + \</span><br><span class="line">        (conf.get(<span class="string">&#x27;expiring_objects_account_name&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;expiring_objects&#x27;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.expiring_objects_container_divisor = \</span><br><span class="line">        <span class="built_in">int</span>(conf.get(<span class="string">&#x27;expiring_objects_container_divisor&#x27;</span>) <span class="keyword">or</span> <span class="number">86400</span>)</span><br><span class="line">    <span class="variable language_">self</span>.max_containers_per_account = \</span><br><span class="line">        <span class="built_in">int</span>(conf.get(<span class="string">&#x27;max_containers_per_account&#x27;</span>) <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">    <span class="variable language_">self</span>.max_containers_whitelist = [</span><br><span class="line">        a.strip()</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> conf.get(<span class="string">&#x27;max_containers_whitelist&#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> a.strip()]</span><br><span class="line">    <span class="variable language_">self</span>.deny_host_headers = [</span><br><span class="line">        host.strip() <span class="keyword">for</span> host <span class="keyword">in</span></span><br><span class="line">        conf.get(<span class="string">&#x27;deny_host_headers&#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;,&#x27;</span>) <span class="keyword">if</span> host.strip()]</span><br><span class="line">    <span class="variable language_">self</span>.rate_limit_after_segment = \</span><br><span class="line">        <span class="built_in">int</span>(conf.get(<span class="string">&#x27;rate_limit_after_segment&#x27;</span>, <span class="number">10</span>))</span><br><span class="line">    <span class="variable language_">self</span>.rate_limit_segments_per_sec = \</span><br><span class="line">        <span class="built_in">int</span>(conf.get(<span class="string">&#x27;rate_limit_segments_per_sec&#x27;</span>, <span class="number">1</span>))</span><br><span class="line">    <span class="variable language_">self</span>.log_handoffs = config_true_value(conf.get(<span class="string">&#x27;log_handoffs&#x27;</span>, <span class="string">&#x27;true&#x27;</span>))</span><br><span class="line">    <span class="variable language_">self</span>.cors_allow_origin = [</span><br><span class="line">        a.strip()</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> conf.get(<span class="string">&#x27;cors_allow_origin&#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> a.strip()]</span><br><span class="line">    <span class="variable language_">self</span>.strict_cors_mode = config_true_value(</span><br><span class="line">        conf.get(<span class="string">&#x27;strict_cors_mode&#x27;</span>, <span class="string">&#x27;t&#x27;</span>))</span><br><span class="line">    <span class="variable language_">self</span>.node_timings = &#123;&#125;</span><br><span class="line">    <span class="variable language_">self</span>.timing_expiry = <span class="built_in">int</span>(conf.get(<span class="string">&#x27;timing_expiry&#x27;</span>, <span class="number">300</span>))</span><br><span class="line">    <span class="variable language_">self</span>.sorting_method = conf.get(<span class="string">&#x27;sorting_method&#x27;</span>, <span class="string">&#x27;shuffle&#x27;</span>).lower()</span><br><span class="line">    <span class="variable language_">self</span>.max_large_object_get_time = <span class="built_in">float</span>(</span><br><span class="line">        conf.get(<span class="string">&#x27;max_large_object_get_time&#x27;</span>, <span class="string">&#x27;86400&#x27;</span>))</span><br><span class="line">    value = conf.get(<span class="string">&#x27;request_node_count&#x27;</span>, <span class="string">&#x27;2 * replicas&#x27;</span>).lower().split()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(value) == <span class="number">1</span>:</span><br><span class="line">        value = <span class="built_in">int</span>(value[<span class="number">0</span>])</span><br><span class="line">        <span class="variable language_">self</span>.request_node_count = <span class="keyword">lambda</span> replicas: value</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(value) == <span class="number">3</span> <span class="keyword">and</span> value[<span class="number">1</span>] == <span class="string">&#x27;*&#x27;</span> <span class="keyword">and</span> value[<span class="number">2</span>] == <span class="string">&#x27;replicas&#x27;</span>:</span><br><span class="line">        value = <span class="built_in">int</span>(value[<span class="number">0</span>])</span><br><span class="line">        <span class="variable language_">self</span>.request_node_count = <span class="keyword">lambda</span> replicas: value * replicas</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(</span><br><span class="line">            <span class="string">&#x27;Invalid request_node_count value: %r&#x27;</span> % <span class="string">&#x27;&#x27;</span>.join(value))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="variable language_">self</span>._read_affinity = read_affinity = conf.get(<span class="string">&#x27;read_affinity&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.read_affinity_sort_key = affinity_key_function(read_affinity)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> err:</span><br><span class="line">        <span class="comment"># make the message a little more useful</span></span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid read_affinity value: %r (%s)&quot;</span> %</span><br><span class="line">                         (read_affinity, err.message))</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        write_affinity = conf.get(<span class="string">&#x27;write_affinity&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.write_affinity_is_local_fn \</span><br><span class="line">            = affinity_locality_predicate(write_affinity)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> err:</span><br><span class="line">        <span class="comment"># make the message a little more useful</span></span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid write_affinity value: %r (%s)&quot;</span> %</span><br><span class="line">                         (write_affinity, err.message))</span><br><span class="line"></span><br><span class="line">    value = conf.get(<span class="string">&#x27;write_affinity_node_count&#x27;</span>,</span><br><span class="line">                     <span class="string">&#x27;2 * replicas&#x27;</span>).lower().split()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(value) == <span class="number">1</span>:</span><br><span class="line">        value = <span class="built_in">int</span>(value[<span class="number">0</span>])</span><br><span class="line">        <span class="variable language_">self</span>.write_affinity_node_count = <span class="keyword">lambda</span> replicas: value</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(value) == <span class="number">3</span> <span class="keyword">and</span> value[<span class="number">1</span>] == <span class="string">&#x27;*&#x27;</span> <span class="keyword">and</span> value[<span class="number">2</span>] == <span class="string">&#x27;replicas&#x27;</span>:</span><br><span class="line">        value = <span class="built_in">int</span>(value[<span class="number">0</span>])</span><br><span class="line">        <span class="variable language_">self</span>.write_affinity_node_count = <span class="keyword">lambda</span> replicas: value * replicas</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(</span><br><span class="line">            <span class="string">&#x27;Invalid write_affinity_node_count value: %r&#x27;</span> % <span class="string">&#x27;&#x27;</span>.join(value))</span><br><span class="line">    <span class="comment"># swift_owner_headers are stripped by the account and container</span></span><br><span class="line">    <span class="comment"># controllers; we should extend header stripping to object controller</span></span><br><span class="line">    <span class="comment"># when a privileged object header is implemented.</span></span><br><span class="line">    swift_owner_headers = conf.get(</span><br><span class="line">        <span class="string">&#x27;swift_owner_headers&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;x-container-read, x-container-write, &#x27;</span></span><br><span class="line">        <span class="string">&#x27;x-container-sync-key, x-container-sync-to, &#x27;</span></span><br><span class="line">        <span class="string">&#x27;x-account-meta-temp-url-key, x-account-meta-temp-url-key-2, &#x27;</span></span><br><span class="line">        <span class="string">&#x27;x-account-access-control&#x27;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.swift_owner_headers = [</span><br><span class="line">        name.strip().title()</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> swift_owner_headers.split(<span class="string">&#x27;,&#x27;</span>) <span class="keyword">if</span> name.strip()]</span><br><span class="line">    <span class="comment"># Initialization was successful, so now apply the client chunk size</span></span><br><span class="line">    <span class="comment"># parameter as the default read / write buffer size for the network</span></span><br><span class="line">    <span class="comment"># sockets.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># NOTE WELL: This is a class setting, so until we get set this on a</span></span><br><span class="line">    <span class="comment"># per-connection basis, this affects reading and writing on ALL</span></span><br><span class="line">    <span class="comment"># sockets, those between the proxy servers and external clients, and</span></span><br><span class="line">    <span class="comment"># those between the proxy servers and the other internal servers.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># ** Because it affects the client as well, currently, we use the</span></span><br><span class="line">    <span class="comment"># client chunk size as the govenor and not the object chunk size.</span></span><br><span class="line">    socket._fileobject.default_bufsize = <span class="variable language_">self</span>.client_chunk_size</span><br><span class="line">    <span class="variable language_">self</span>.expose_info = config_true_value(</span><br><span class="line">        conf.get(<span class="string">&#x27;expose_info&#x27;</span>, <span class="string">&#x27;yes&#x27;</span>))</span><br><span class="line">    <span class="variable language_">self</span>.disallowed_sections = list_from_csv(</span><br><span class="line">        conf.get(<span class="string">&#x27;disallowed_sections&#x27;</span>))</span><br><span class="line">    <span class="variable language_">self</span>.admin_key = conf.get(<span class="string">&#x27;admin_key&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    register_swift_info(</span><br><span class="line">        version=swift_version,</span><br><span class="line">        strict_cors_mode=<span class="variable language_">self</span>.strict_cors_mode,</span><br><span class="line">        **constraints.EFFECTIVE_CONSTRAINTS)</span><br></pre></td></tr></table></figure>
<p>proxy server的初始化函数，具体配置的说明可以参考<a target="_blank" rel="noopener" href="http://docs.openstack.org/havana/config-reference/content/proxy-server-conf.html">这里</a>。</p>
<h3 id="check-config"><a href="#check-config" class="headerlink" title="check_config"></a>check_config</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_config</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Check the configuration for possible errors</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>._read_affinity <span class="keyword">and</span> <span class="variable language_">self</span>.sorting_method != <span class="string">&#x27;affinity&#x27;</span>:</span><br><span class="line">        <span class="variable language_">self</span>.logger.warn(<span class="string">&quot;sorting_method is set to &#x27;%s&#x27;, not &#x27;affinity&#x27;; &quot;</span></span><br><span class="line">                         <span class="string">&quot;read_affinity setting will have no effect.&quot;</span> %</span><br><span class="line">                         <span class="variable language_">self</span>.sorting_method)</span><br></pre></td></tr></table></figure>  
<p>proxy server初始化后被调用的方法，检查proxy的read_affinity配置和排序方法设置不一致时，记录警告日志。  </p>
<h3 id="call方法"><a href="#call方法" class="headerlink" title="call方法"></a>call方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, env, start_response</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        WSGI entry point.</span></span><br><span class="line"><span class="string">        Wraps env in swob.Request object and passes it down.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param env: WSGI environment dictionary</span></span><br><span class="line"><span class="string">        :param start_response: WSGI callable</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.memcache <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="variable language_">self</span>.memcache = cache_from_env(env)</span><br><span class="line">            req = <span class="variable language_">self</span>.update_request(Request(env))</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.handle_request(req)(env, start_response)</span><br><span class="line">        <span class="keyword">except</span> UnicodeError:</span><br><span class="line">            err = HTTPPreconditionFailed(</span><br><span class="line">                request=req, body=<span class="string">&#x27;Invalid UTF8 or contains NULL&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> err(env, start_response)</span><br><span class="line">        <span class="keyword">except</span> (Exception, Timeout):</span><br><span class="line">            start_response(<span class="string">&#x27;500 Server Error&#x27;</span>,</span><br><span class="line">                           [(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)])</span><br><span class="line">            <span class="keyword">return</span> [<span class="string">&#x27;Internal server error.\n&#x27;</span>]</span><br></pre></td></tr></table></figure>  
<ul>
<li>9~10: 检查memcache缓存是否为空，如果为空的话就从上下文中获取，由于proxy-server在pipeline中是最后面，如果pipeline前面配置了memcache中间件的话，就可以从上下文中取到。  </li>
<li>12: 调用update_request方法，后面会介绍。  </li>
<li>13: 调用handle_request方法，后面会介绍，最后返回response。  </li>
<li>14~17: 捕获UnicodeError并返回412。  </li>
<li>18~21: 捕获Timeout和其他异常并返回500。</li>
</ul>
<h3 id="update-request"><a href="#update-request" class="headerlink" title="update_request"></a>update_request</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_request</span>(<span class="params">self, req</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;x-storage-token&#x27;</span> <span class="keyword">in</span> req.headers <span class="keyword">and</span> \</span><br><span class="line">            <span class="string">&#x27;x-auth-token&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> req.headers:</span><br><span class="line">        req.headers[<span class="string">&#x27;x-auth-token&#x27;</span>] = req.headers[<span class="string">&#x27;x-storage-token&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> req</span><br></pre></td></tr></table></figure>  
<p>该方法是将requeset中的x-auth-token的header替换为x-storage-token的header。  </p>
<h3 id="handle-request"><a href="#handle-request" class="headerlink" title="handle_request"></a>handle_request</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">handle_request</span>(<span class="params">self, req</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Entry point for proxy server.</span></span><br><span class="line"><span class="string">        Should return a WSGI-style callable (such as swob.Response).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param req: swob.Request object</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.logger.set_statsd_prefix(<span class="string">&#x27;proxy-server&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> req.content_length <span class="keyword">and</span> req.content_length &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="variable language_">self</span>.logger.increment(<span class="string">&#x27;errors&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> HTTPBadRequest(request=req,</span><br><span class="line">                                      body=<span class="string">&#x27;Invalid Content-Length&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> check_utf8(req.path_info):</span><br><span class="line">                    <span class="variable language_">self</span>.logger.increment(<span class="string">&#x27;errors&#x27;</span>)</span><br><span class="line">                    <span class="keyword">return</span> HTTPPreconditionFailed(</span><br><span class="line">                        request=req, body=<span class="string">&#x27;Invalid UTF8 or contains NULL&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> UnicodeError:</span><br><span class="line">                <span class="variable language_">self</span>.logger.increment(<span class="string">&#x27;errors&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> HTTPPreconditionFailed(</span><br><span class="line">                    request=req, body=<span class="string">&#x27;Invalid UTF8 or contains NULL&#x27;</span>)</span><br></pre></td></tr></table></figure>  
<ul>
<li>8: 在log中设置’proxy-server’前缀。  </li>
<li>10~13: 检查request中content length如果有且长度为0，则返回500。  </li>
<li>15~23  : 检查url格式是否utf-8，如果不是则返回412。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    controller, path_parts = <span class="variable language_">self</span>.get_controller(req.path)</span><br><span class="line">    p = req.path_info</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(p, unicode):</span><br><span class="line">        p = p.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> ValueError:</span><br><span class="line">    <span class="variable language_">self</span>.logger.increment(<span class="string">&#x27;errors&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> HTTPNotFound(request=req)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> controller:</span><br><span class="line">    <span class="variable language_">self</span>.logger.increment(<span class="string">&#x27;errors&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> HTTPPreconditionFailed(request=req, body=<span class="string">&#x27;Bad URL&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="variable language_">self</span>.deny_host_headers <span class="keyword">and</span> \</span><br><span class="line">        req.host.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>] <span class="keyword">in</span> <span class="variable language_">self</span>.deny_host_headers:</span><br><span class="line">    <span class="keyword">return</span> HTTPForbidden(request=req, body=<span class="string">&#x27;Invalid host header&#x27;</span>)</span><br></pre></td></tr></table></figure>  
<ul>
<li>2～5: 调用get_controller方法(后面会介绍)，通过url获取对应的controller类和url中通过’&#x2F;‘符号分割的各个部分。  </li>
<li>6~8: 捕获ValueError并返回404。  </li>
<li>9~11: 如果controller类为空则返回404。  </li>
<li>12~14: 如果proxy中有定义deny_host_headers(禁止访问的ip），并且request的ip与禁止访问的ip一致，则返回403。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">self</span>.logger.set_statsd_prefix(<span class="string">&#x27;proxy-server.&#x27;</span> +</span><br><span class="line">                              controller.server_type.lower())</span><br><span class="line">controller = controller(<span class="variable language_">self</span>, **path_parts)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;swift.trans_id&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> req.environ:</span><br><span class="line">    <span class="comment"># if this wasn&#x27;t set by an earlier middleware, set it now</span></span><br><span class="line">    trans_id = generate_trans_id(<span class="variable language_">self</span>.trans_id_suffix)</span><br><span class="line">    req.environ[<span class="string">&#x27;swift.trans_id&#x27;</span>] = trans_id</span><br><span class="line">    <span class="variable language_">self</span>.logger.txn_id = trans_id</span><br><span class="line">req.headers[<span class="string">&#x27;x-trans-id&#x27;</span>] = req.environ[<span class="string">&#x27;swift.trans_id&#x27;</span>]</span><br><span class="line">controller.trans_id = req.environ[<span class="string">&#x27;swift.trans_id&#x27;</span>]</span><br><span class="line"><span class="variable language_">self</span>.logger.client_ip = get_remote_client(req)</span><br></pre></td></tr></table></figure>  
<ul>
<li>1～2: 日志加上controller名字前缀。</li>
<li>3: 通过controller类实例化controller对象。</li>
<li>4~10: 如果swift.trans_id没有在request的上下文中，则重新生成trans_id，并设置在上下文、日志、header和controller中。  </li>
<li>11: 调用get_remote_client方法(后面介绍)，先判断header中是否有’x-cluster-client-ip’，如果没有再去获取header中的’x-forwarded-for’，还是没有的话就从request中的remote_addr取值，得到client_ip。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    handler = <span class="built_in">getattr</span>(controller, req.method)</span><br><span class="line">    <span class="built_in">getattr</span>(handler, <span class="string">&#x27;publicly_accessible&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> AttributeError:</span><br><span class="line">    allowed_methods = <span class="built_in">getattr</span>(controller, <span class="string">&#x27;allowed_methods&#x27;</span>, <span class="built_in">set</span>())</span><br><span class="line">    <span class="keyword">return</span> HTTPMethodNotAllowed(</span><br><span class="line">        request=req, headers=&#123;<span class="string">&#x27;Allow&#x27;</span>: <span class="string">&#x27;, &#x27;</span>.join(allowed_methods)&#125;)</span><br></pre></td></tr></table></figure>  
<ul>
<li>2~3: 通过request的method，在controller得到一个名字相同，并且有’public’标签的方法对象handler。</li>
<li>4~7: 如果获取不到对应的public方法，则打印出controller中所有public方法并返回405。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">&#x27;swift.authorize&#x27;</span> <span class="keyword">in</span> req.environ:</span><br><span class="line">    <span class="comment"># We call authorize before the handler, always. If authorized,</span></span><br><span class="line">    <span class="comment"># we remove the swift.authorize hook so isn&#x27;t ever called</span></span><br><span class="line">    <span class="comment"># again. If not authorized, we return the denial unless the</span></span><br><span class="line">    <span class="comment"># controller&#x27;s method indicates it&#x27;d like to gather more</span></span><br><span class="line">    <span class="comment"># information and try again later.</span></span><br><span class="line">    resp = req.environ[<span class="string">&#x27;swift.authorize&#x27;</span>](req)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp:</span><br><span class="line">        <span class="comment"># No resp means authorized, no delayed recheck required.</span></span><br><span class="line">        <span class="keyword">del</span> req.environ[<span class="string">&#x27;swift.authorize&#x27;</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Response indicates denial, but we might delay the denial</span></span><br><span class="line">        <span class="comment"># and recheck later. If not delayed, return the error now.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">getattr</span>(handler, <span class="string">&#x27;delay_denial&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>  
<p>如果request的上下文中有swift.authorize，则调用这个方法进行认证。<br>如果没有返回结果证明之前已经认证通过了，后面的请求不需要再认证，将’swift.authorize’从上下文去掉。<br>如果有Response返回则表示认证不通过，会先检查是否有延迟禁止的配置，如果没有返回认证不通过的response，如果有则会等后面再重新确认。  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"># Save off original request method (GET, POST, etc.) in case it</span></span><br><span class="line">    <span class="comment"># gets mutated during handling.  This way logging can display the</span></span><br><span class="line">    <span class="comment"># method the client actually sent.</span></span><br><span class="line">    req.environ[<span class="string">&#x27;swift.orig_req_method&#x27;</span>] = req.method</span><br><span class="line">    <span class="keyword">return</span> handler(req)</span><br><span class="line"><span class="keyword">except</span> HTTPException <span class="keyword">as</span> error_response:</span><br><span class="line">    <span class="keyword">return</span> error_response</span><br><span class="line"><span class="keyword">except</span> (Exception, Timeout):</span><br><span class="line">    <span class="variable language_">self</span>.logger.exception(_(<span class="string">&#x27;ERROR Unhandled exception in request&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> HTTPServerError(request=req)</span><br></pre></td></tr></table></figure>  
<ul>
<li>4~5: 在日志中记录原始的request方法，防止请求在传播过程中发生突变http请求方法发生改变。</li>
<li>6~10: 捕获异常，记录日志。</li>
</ul>
<h3 id="get-controller"><a href="#get-controller" class="headerlink" title="get_controller"></a>get_controller</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_controller</span>(<span class="params">self, path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Get the controller to handle a request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param path: path from request</span></span><br><span class="line"><span class="string">    :returns: tuple of (controller class, path dictionary)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :raises: ValueError (thrown by split_path) if given invalid path</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> path == <span class="string">&#x27;/info&#x27;</span>:</span><br><span class="line">        d = <span class="built_in">dict</span>(version=<span class="literal">None</span>,</span><br><span class="line">                 expose_info=<span class="variable language_">self</span>.expose_info,</span><br><span class="line">                 disallowed_sections=<span class="variable language_">self</span>.disallowed_sections,</span><br><span class="line">                 admin_key=<span class="variable language_">self</span>.admin_key)</span><br><span class="line">        <span class="keyword">return</span> InfoController, d</span><br><span class="line"></span><br><span class="line">    version, account, container, obj = split_path(path, <span class="number">1</span>, <span class="number">4</span>, <span class="literal">True</span>)</span><br><span class="line">    d = <span class="built_in">dict</span>(version=version,</span><br><span class="line">             account_name=account,</span><br><span class="line">             container_name=container,</span><br><span class="line">             object_name=obj)</span><br><span class="line">    <span class="keyword">if</span> obj <span class="keyword">and</span> container <span class="keyword">and</span> account:</span><br><span class="line">        <span class="keyword">return</span> ObjectController, d</span><br><span class="line">    <span class="keyword">elif</span> container <span class="keyword">and</span> account:</span><br><span class="line">        <span class="keyword">return</span> ContainerController, d</span><br><span class="line">    <span class="keyword">elif</span> account <span class="keyword">and</span> <span class="keyword">not</span> container <span class="keyword">and</span> <span class="keyword">not</span> obj:</span><br><span class="line">        <span class="keyword">return</span> AccountController, d</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span>, d</span><br></pre></td></tr></table></figure>  
<ul>
<li>10～15: 如果url是’info’，则返回InController和controller字典参数，expose_info表示是否暴露信息，disallowed_sections表示不允许暴露的字段列表，比如container_qutoas, tempurl等。</li>
<li>17～28: 根据url判断是account、container还是object，返回对应的controller和字典参数。</li>
</ul>
<h3 id="sort-nodes"><a href="#sort-nodes" class="headerlink" title="sort_nodes"></a>sort_nodes</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">sort_nodes</span>(<span class="params">self, nodes</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Sorts nodes in-place (and returns the sorted list) according to</span></span><br><span class="line"><span class="string">    the configured strategy. The default &quot;sorting&quot; is to randomly</span></span><br><span class="line"><span class="string">    shuffle the nodes. If the &quot;timing&quot; strategy is chosen, the nodes</span></span><br><span class="line"><span class="string">    are sorted according to the stored timing data.</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># In the case of timing sorting, shuffling ensures that close timings</span></span><br><span class="line">    <span class="comment"># (ie within the rounding resolution) won&#x27;t prefer one over another.</span></span><br><span class="line">    <span class="comment"># Python&#x27;s sort is stable (http://wiki.python.org/moin/HowTo/Sorting/)</span></span><br><span class="line">    shuffle(nodes)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.sorting_method == <span class="string">&#x27;timing&#x27;</span>:</span><br><span class="line">        now = time()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">key_func</span>(<span class="params">node</span>):</span><br><span class="line">            timing, expires = <span class="variable language_">self</span>.node_timings.get(node[<span class="string">&#x27;ip&#x27;</span>], (-<span class="number">1.0</span>, <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> timing <span class="keyword">if</span> expires &gt; now <span class="keyword">else</span> -<span class="number">1.0</span></span><br><span class="line">        nodes.sort(key=key_func)</span><br><span class="line">    <span class="keyword">elif</span> <span class="variable language_">self</span>.sorting_method == <span class="string">&#x27;affinity&#x27;</span>:</span><br><span class="line">        nodes.sort(key=<span class="variable language_">self</span>.read_affinity_sort_key)</span><br><span class="line">    <span class="keyword">return</span> nodes</span><br></pre></td></tr></table></figure>  
<p>节点的排序方法，将节点根据配置的排序策略进行排序。  </p>
<ul>
<li>11: 将节点顺序打乱，确保节点不会按照时间排好序。</li>
<li>12～18: 如果配置的排序策略是按时间排序，则定义一个（节点）按时间排序的方法让节点按照这个方法排序，如果节点已过期则timing为-0.1，即会被排到最后。</li>
<li>19～20: 如果配置的排序策略是按亲和力排序，则节点按照亲和力方法排序。</li>
</ul>
<h3 id="set-node-timing"><a href="#set-node-timing" class="headerlink" title="set_node_timing"></a>set_node_timing</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">set_node_timing</span>(<span class="params">self, node, timing</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.sorting_method != <span class="string">&#x27;timing&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    now = time()</span><br><span class="line">    timing = <span class="built_in">round</span>(timing, <span class="number">3</span>)  <span class="comment"># sort timings to the millisecond</span></span><br><span class="line">    <span class="variable language_">self</span>.node_timings[node[<span class="string">&#x27;ip&#x27;</span>]] = (timing, now + <span class="variable language_">self</span>.timing_expiry)</span><br></pre></td></tr></table></figure>  
<ul>
<li>2～3: 如果配置的排序策略不是’timing’，则直接返回不做设置。</li>
<li>4～6: 设置单个节点的排序时间过期时间。</li>
</ul>
<h3 id="error-limited"><a href="#error-limited" class="headerlink" title="error_limited"></a>error_limited</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">error_limited</span>(<span class="params">self, node</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Check if the node is currently error limited.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param node: dictionary of node to check</span></span><br><span class="line"><span class="string">    :returns: True if error limited, False otherwise</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    now = time()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;errors&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> node:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;last_error&#x27;</span> <span class="keyword">in</span> node <span class="keyword">and</span> node[<span class="string">&#x27;last_error&#x27;</span>] &lt; \</span><br><span class="line">            now - <span class="variable language_">self</span>.error_suppression_interval:</span><br><span class="line">        <span class="keyword">del</span> node[<span class="string">&#x27;last_error&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;errors&#x27;</span> <span class="keyword">in</span> node:</span><br><span class="line">            <span class="keyword">del</span> node[<span class="string">&#x27;errors&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    limited = node[<span class="string">&#x27;errors&#x27;</span>] &gt; <span class="variable language_">self</span>.error_suppression_limit</span><br><span class="line">    <span class="keyword">if</span> limited:</span><br><span class="line">        <span class="variable language_">self</span>.logger.debug(</span><br><span class="line">            _(<span class="string">&#x27;Node error limited %(ip)s:%(port)s (%(device)s)&#x27;</span>), node)</span><br><span class="line">    <span class="keyword">return</span> limited</span><br></pre></td></tr></table></figure>  
<ul>
<li>8～10: 如果节点里面没有’errors’选项，则返回false。</li>
<li>11～10: 如果节点里面的’last_error’选项不正确，则删除该选项和errors选项，并返回false。</li>
<li>12～15: 判断节点的错误个数是否超过配置的错误限制，如果超过则记录日志，并返回是否超限制的结果。</li>
</ul>
<h3 id="error-limit"><a href="#error-limit" class="headerlink" title="error_limit"></a>error_limit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">error_limit</span>(<span class="params">self, node, msg</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Mark a node as error limited. This immediately pretends the</span></span><br><span class="line"><span class="string">    node received enough errors to trigger error suppression. Use</span></span><br><span class="line"><span class="string">    this for errors like Insufficient Storage. For other errors</span></span><br><span class="line"><span class="string">    use :func:`error_occurred`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param node: dictionary of node to error limit</span></span><br><span class="line"><span class="string">    :param msg: error message</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    node[<span class="string">&#x27;errors&#x27;</span>] = <span class="variable language_">self</span>.error_suppression_limit + <span class="number">1</span></span><br><span class="line">    node[<span class="string">&#x27;last_error&#x27;</span>] = time()</span><br><span class="line">    <span class="variable language_">self</span>.logger.error(_(<span class="string">&#x27;%(msg)s %(ip)s:%(port)s/%(device)s&#x27;</span>),</span><br><span class="line">                      &#123;<span class="string">&#x27;msg&#x27;</span>: msg, <span class="string">&#x27;ip&#x27;</span>: node[<span class="string">&#x27;ip&#x27;</span>],</span><br><span class="line">                      <span class="string">&#x27;port&#x27;</span>: node[<span class="string">&#x27;port&#x27;</span>], <span class="string">&#x27;device&#x27;</span>: node[<span class="string">&#x27;device&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure>  
<ul>
<li>11～14: 记录一个节点的错误信息:错误个数，最后错误的时间，并记录日志。</li>
</ul>
<h3 id="error-occurred"><a href="#error-occurred" class="headerlink" title="error_occurred"></a>error_occurred</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">error_occurred</span>(<span class="params">self, node, msg</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Handle logging, and handling of errors.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param node: dictionary of node to handle errors for</span></span><br><span class="line"><span class="string">    :param msg: error message</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    node[<span class="string">&#x27;errors&#x27;</span>] = node.get(<span class="string">&#x27;errors&#x27;</span>, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    node[<span class="string">&#x27;last_error&#x27;</span>] = time()</span><br><span class="line">    <span class="variable language_">self</span>.logger.error(_(<span class="string">&#x27;%(msg)s %(ip)s:%(port)s/%(device)s&#x27;</span>),</span><br><span class="line">                      &#123;<span class="string">&#x27;msg&#x27;</span>: msg, <span class="string">&#x27;ip&#x27;</span>: node[<span class="string">&#x27;ip&#x27;</span>],</span><br><span class="line">                      <span class="string">&#x27;port&#x27;</span>: node[<span class="string">&#x27;port&#x27;</span>], <span class="string">&#x27;device&#x27;</span>: node[<span class="string">&#x27;device&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure>  
<ul>
<li>8～12: 与前面的方法类似，唯一区别是记录节点错误个数是取当前的错误个数，然后+1。</li>
</ul>
<h3 id="iter-nodes"><a href="#iter-nodes" class="headerlink" title="iter_nodes"></a>iter_nodes</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">iter_nodes</span>(<span class="params">self, ring, partition, node_iter=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Yields nodes for a ring partition, skipping over error</span></span><br><span class="line"><span class="string">    limited nodes and stopping at the configurable number of</span></span><br><span class="line"><span class="string">    nodes. If a node yielded subsequently gets error limited, an</span></span><br><span class="line"><span class="string">    extra node will be yielded to take its place.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Note that if you&#x27;re going to iterate over this concurrently from</span></span><br><span class="line"><span class="string">    multiple greenthreads, you&#x27;ll want to use a</span></span><br><span class="line"><span class="string">    swift.common.utils.GreenthreadSafeIterator to serialize access.</span></span><br><span class="line"><span class="string">    Otherwise, you may get ValueErrors from concurrent access. (You also</span></span><br><span class="line"><span class="string">    may not, depending on how logging is configured, the vagaries of</span></span><br><span class="line"><span class="string">    socket IO and eventlet, and the phase of the moon.)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param ring: ring to get yield nodes from</span></span><br><span class="line"><span class="string">    :param partition: ring partition to yield nodes for</span></span><br><span class="line"><span class="string">    :param node_iter: optional iterable of nodes to try. Useful if you</span></span><br><span class="line"><span class="string">        want to filter or reorder the nodes.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    part_nodes = ring.get_part_nodes(partition)</span><br><span class="line">    <span class="keyword">if</span> node_iter <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        node_iter = itertools.chain(part_nodes,</span><br><span class="line">                                    ring.get_more_nodes(partition))</span><br><span class="line">    num_primary_nodes = <span class="built_in">len</span>(part_nodes)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use of list() here forcibly yanks the first N nodes (the primary</span></span><br><span class="line">    <span class="comment"># nodes) from node_iter, so the rest of its values are handoffs.</span></span><br><span class="line">    primary_nodes = <span class="variable language_">self</span>.sort_nodes(</span><br><span class="line">        <span class="built_in">list</span>(itertools.islice(node_iter, num_primary_nodes)))</span><br><span class="line">    handoff_nodes = node_iter</span><br><span class="line">    nodes_left = <span class="variable language_">self</span>.request_node_count(<span class="built_in">len</span>(primary_nodes))</span><br></pre></td></tr></table></figure>  
<ul>
<li>20～24: 根据partition获取相应的节点，如果node_iter为空，则将之前取到的节点和get_more_nodes节点连接起来为node_iter赋值，并取得节点个数。</li>
<li>28～31: 将node_iter的节点重新排序，并取前面部分作为主要nodes，handoff_nodes为node_iter剩下的nodes， nodes_left为剩下的节点个数。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> primary_nodes:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.error_limited(node):</span><br><span class="line">        <span class="keyword">yield</span> node</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.error_limited(node):</span><br><span class="line">            nodes_left -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> nodes_left &lt;= <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">handoffs = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> handoff_nodes:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.error_limited(node):</span><br><span class="line">        handoffs += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.log_handoffs:</span><br><span class="line">            <span class="variable language_">self</span>.logger.increment(<span class="string">&#x27;handoff_count&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.logger.warning(</span><br><span class="line">                <span class="string">&#x27;Handoff requested (%d)&#x27;</span> % handoffs)</span><br><span class="line">            <span class="keyword">if</span> handoffs == <span class="built_in">len</span>(primary_nodes):</span><br><span class="line">                <span class="variable language_">self</span>.logger.increment(<span class="string">&#x27;handoff_all_count&#x27;</span>)</span><br><span class="line">        <span class="keyword">yield</span> node</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.error_limited(node):</span><br><span class="line">            nodes_left -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> nodes_left &lt;= <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br></pre></td></tr></table></figure>  
<ul>
<li>1～7: 遍历每个主节点，如果节点没有错误则返回该节点，剩余节点数-1,如果剩余节点数&lt;&#x3D;0,则直接返回。</li>
<li>8～22: 如果主节点中都有错误，则从剩余节点中查找满足条件的节点，查找方法和主节点查找方法雷同，只是多了一些日志的记录。</li>
</ul>
<h3 id="exception-occurred"><a href="#exception-occurred" class="headerlink" title="exception_occurred"></a>exception_occurred</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exception_occurred</span>(<span class="params">self, node, typ, additional_info</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Handle logging of generic exceptions.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param node: dictionary of node to log the error for</span></span><br><span class="line"><span class="string">    :param typ: server type</span></span><br><span class="line"><span class="string">    :param additional_info: additional information to log</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="variable language_">self</span>.logger.exception(</span><br><span class="line">        _(<span class="string">&#x27;ERROR with %(type)s server %(ip)s:%(port)s/%(device)s re: &#x27;</span></span><br><span class="line">          <span class="string">&#x27;%(info)s&#x27;</span>),</span><br><span class="line">        &#123;<span class="string">&#x27;type&#x27;</span>: typ, <span class="string">&#x27;ip&#x27;</span>: node[<span class="string">&#x27;ip&#x27;</span>], <span class="string">&#x27;port&#x27;</span>: node[<span class="string">&#x27;port&#x27;</span>],</span><br><span class="line">         <span class="string">&#x27;device&#x27;</span>: node[<span class="string">&#x27;device&#x27;</span>], <span class="string">&#x27;info&#x27;</span>: additional_info&#125;)</span><br></pre></td></tr></table></figure>  
<ul>
<li>9～13: 当异常发生的时候，记录异常日志。</li>
</ul>
<h3 id="modify-wsgi-pipeline"><a href="#modify-wsgi-pipeline" class="headerlink" title="modify_wsgi_pipeline"></a>modify_wsgi_pipeline</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">modify_wsgi_pipeline</span>(<span class="params">self, pipe</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Called during WSGI pipeline creation. Modifies the WSGI pipeline</span></span><br><span class="line"><span class="string">    context to ensure that mandatory middleware is present in the pipeline.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param pipe: A PipelineWrapper object</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    pipeline_was_modified = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> filter_spec <span class="keyword">in</span> <span class="built_in">reversed</span>(required_filters):</span><br><span class="line">        filter_name = filter_spec[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> filter_name <span class="keyword">not</span> <span class="keyword">in</span> pipe:</span><br><span class="line">            afters = filter_spec.get(<span class="string">&#x27;after_fn&#x27;</span>, <span class="keyword">lambda</span> _junk: [])(pipe)</span><br><span class="line">            insert_at = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> after <span class="keyword">in</span> afters:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    insert_at = <span class="built_in">max</span>(insert_at, pipe.index(after) + <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">except</span> ValueError:  <span class="comment"># not in pipeline; ignore it</span></span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line">            <span class="variable language_">self</span>.logger.info(</span><br><span class="line">                <span class="string">&#x27;Adding required filter %s to pipeline at position %d&#x27;</span> %</span><br><span class="line">                (filter_name, insert_at))</span><br><span class="line">            ctx = pipe.create_filter(filter_name)</span><br><span class="line">            pipe.insert_filter(ctx, index=insert_at)</span><br><span class="line">            pipeline_was_modified = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pipeline_was_modified:</span><br><span class="line">        <span class="variable language_">self</span>.logger.info(<span class="string">&quot;Pipeline was modified. New pipeline is \&quot;%s\&quot;.&quot;</span>,</span><br><span class="line">                         pipe)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="variable language_">self</span>.logger.debug(<span class="string">&quot;Pipeline is \&quot;%s\&quot;&quot;</span>, pipe)</span><br></pre></td></tr></table></figure>  
<ul>
<li>8～24: 遍历定义好的中间件required_filters，如果该中间件没有在pipeline中，则将该中间件插入到pipeline，插入位置根据中间件的atfer_fn方法得到。</li>
<li>26～31: 记录人日志信息。</li>
</ul>
<h3 id="required-filters"><a href="#required-filters" class="headerlink" title="required_filters"></a>required_filters</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># List of entry points for mandatory middlewares.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Fields:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># &quot;name&quot; (required) is the entry point name from setup.py.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># &quot;after_fn&quot; (optional) a function that takes a PipelineWrapper object as its</span></span><br><span class="line"><span class="comment"># single argument and returns a list of middlewares that this middleware</span></span><br><span class="line"><span class="comment"># should come after. Any middlewares in the returned list that are not present</span></span><br><span class="line"><span class="comment"># in the pipeline will be ignored, so you can safely name optional middlewares</span></span><br><span class="line"><span class="comment"># to come after. For example, [&quot;catch_errors&quot;, &quot;bulk&quot;] would install this</span></span><br><span class="line"><span class="comment"># middleware after catch_errors and bulk if both were present, but if bulk</span></span><br><span class="line"><span class="comment"># were absent, would just install it after catch_errors.</span></span><br><span class="line"></span><br><span class="line">required_filters = [</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;catch_errors&#x27;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;gatekeeper&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;after_fn&#x27;</span>: <span class="keyword">lambda</span> pipe: ([<span class="string">&#x27;catch_errors&#x27;</span>]</span><br><span class="line">                               <span class="keyword">if</span> pipe.startswith(<span class="string">&quot;catch_errors&quot;</span>)</span><br><span class="line">                               <span class="keyword">else</span> [])&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dlo&#x27;</span>, <span class="string">&#x27;after_fn&#x27;</span>: <span class="keyword">lambda</span> _junk: [<span class="string">&#x27;catch_errors&#x27;</span>, <span class="string">&#x27;gatekeeper&#x27;</span>,</span><br><span class="line">                                               <span class="string">&#x27;proxy_logging&#x27;</span>]&#125;]</span><br></pre></td></tr></table></figure>  
<ul>
<li>modify_wsgi_pipeline方法用到的required_filters。</li>
</ul>
<h3 id="app-factory"><a href="#app-factory" class="headerlink" title="app_factory"></a>app_factory</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">app_factory</span>(<span class="params">global_conf, **local_conf</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;paste.deploy app factory for creating WSGI proxy apps.&quot;&quot;&quot;</span></span><br><span class="line">    conf = global_conf.copy()</span><br><span class="line">    conf.update(local_conf)</span><br><span class="line">    app = Application(conf)</span><br><span class="line">    app.check_config()</span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>  
<ul>
<li>proxy server的工厂方法，初始化server对象并检查配置，然后返回创建好的对象。</li>
</ul>
</div>

</article>
<section id="appreciates">
  <center>
	<h2>赞赏</h2>
    <div class="post-footer">
      <div>
	    <h4>如果文章对您有所帮助，可以捐赠我喝杯咖啡😌，捐赠方式：</h4>
        <div class="digital-wallet">
          <h6>BTC 地址：3LYgSyf7ddMALwGWPQr3PY4wzjsTDdg1oV</h6>
          <h6>ETH 地址：0x0C9b27c89A61aadb0aEC24CA8949910Cbf77Aa73</h6>
        </div>
        <div class="wechat_appreciates">
          <img src="/images/wechat_appreciates.png" alt="qrcode" width="250" >
        </div>
      </div>
      <div>
	    <h4>文章已同步更新公众号，欢迎关注</h4>
        <div class="wechat_appreciates">
          <img src="/images/wxgzh_qrcode.jpg" alt="qrcode" width="250" >
        </div>
      </div>
    </div>
  </center>
</section>



    
      <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = 'https://zhaozhiming.github.io/2014/04/20/swift-code-explain-proxy-server/';
            this.page.identifier = 'https://zhaozhiming.github.io/2014/04/20/swift-code-explain-proxy-server/';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//zhaozhiming.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

</div>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2024

    赵芝明
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a target="_blank" rel="noopener" href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a target="_blank" rel="noopener" href="http://github.com/panks/fabric">fabric</a> by <a target="_blank" rel="noopener" href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5608723650603289" crossorigin="anonymous"></script>
</body>
</html>
