<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>OSGi的简单代码示例 - Hacker and Geeker&#39;s Way</title>
    <meta name="author" content="">
    
	<meta name="description" content="OSGI的简答代码示例"> <!-- TODO: truncate -->
	<meta name="keywords" content="osgi,felix">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="Hacker and Geeker&#39;s Way" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='/stylesheets/font.css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/font.css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/font.css?family=Amethysta+One' rel='stylesheet' type='text/css'>
	  <script src="/javascripts/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-100485541-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


<meta name="generator" content="Hexo 6.3.0"></head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Hacker and Geeker&#39;s Way
    </div>
</h1>
<span class="subtitle"></span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a target="_blank" rel="noopener" href="https://github.com/zhaozhiming" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a target="_blank" rel="noopener" href="http://www.twitter.com/kingzzm" class="twitter" title="Twitter"></a>
  </li>
  
  
  <!-- LinkedIn -->
  <li>
  <a target="_blank" rel="noopener" href="http://www.linkedin.com/in/zhaozhiming" class="linkedin" title="LinkedIn"></a>
  </li>
  
  
  
  
  
  <!-- Stackoverflow -->
  <li>
  <a target="_blank" rel="noopener" href="http://stackoverflow.com/users/1954315/zhaozhiming" class="stackoverflow" title="Stackoverflow"></a>
  </li>
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    <li><a href="/about/index.html">About</a></li>
    
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="https://zhaozhiming.github.io" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>


<div id="toload">
<!-- begin toload -->
    <div id="content">
        <div class="inner">
<article class="post">
	<h2 class="title">OSGi的简单代码示例</h2>
    <div class="meta">
        <div class="date">Published on: <time datetime="2015-01-25T12:35:00.000Z" itemprop="datePublished">1月 25, 2015</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/osgi/">osgi</a> <a href="/tags/felix/">felix</a>
</div>
    </div>
	<div class="entry-content"><img src="/images/post/2015-1/osgi.gif" class="">  
<p>OSGi(Open Service Gateway Initiative)是面向Java的动态模型系统，使用OSGi可以进行模块的动态加载，无需停止重启服务器，而模块就是我们下面要开发的Bundle。OSGi在电信或其他大型企业里面用的比较多，Eclipse现在也是用osgi的方式来添加插件。  </p>
<span id="more"></span>  
<h2 id="IntelliJ-IDEA的OSGi环境搭建"><a href="#IntelliJ-IDEA的OSGi环境搭建" class="headerlink" title="IntelliJ IDEA的OSGi环境搭建"></a>IntelliJ IDEA的OSGi环境搭建</h2><ul>
<li>我们使用<a target="_blank" rel="noopener" href="http://felix.apache.org/">Felix</a>这个OSGi框架来进行OSGi代码的开发，首先我们下载最新版本的Felix包并解压</li>
</ul>
<img src="/images/post/2015-1/felix_download.png" class="">  
<ul>
<li>在IDEA进行OSGi的设置，选择刚才解压好的felix目录</li>
</ul>
<img src="/images/post/2015-1/felix_idea_setting_1.png" class="">  

<img src="/images/post/2015-1/felix_idea_setting_2.png" class="">  	
<ul>
<li>写一个简单的Activator，下面要用到</li>
</ul>
<figure class="highlight java"><figcaption><span>HelloActivator.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzm.osgi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleActivator;</span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloActivator</span> <span class="keyword">implements</span> <span class="title class_">BundleActivator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(BundleContext bundleContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World Bundle started!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">(BundleContext bundleContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World Bundle stop!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 
<ul>
<li>在工程设置页面进行设置，写上bundle对应的Activator</li>
</ul>
<img src="/images/post/2015-1/idea_project_setting_1.png" class="">  
<img src="/images/post/2015-1/idea_project_setting_2.png" class="">  
<img src="/images/post/2015-1/idea_project_setting_3.png" class="">  
<ul>
<li>在Run菜单中添加osgi的运行配置，Run-&gt;Edit Configurations…</li>
</ul>
<img src="/images/post/2015-1/felix_idea_run_setting_1.png" class="">

<img src="/images/post/2015-1/felix_idea_run_setting_2.png" class="">  
<img src="/images/post/2015-1/felix_idea_run_setting_3.png" class="">  
<img src="/images/post/2015-1/felix_idea_run_setting_4.png" class="">  
<img src="/images/post/2015-1/felix_idea_run_setting_5.png" class="">  

<ul>
<li>运行felix</li>
</ul>
<img src="/images/post/2015-1/felix_idea_running_1.png" class="">  
<p>可以看到IDEA已经帮我们自动启动了我们的Activator，打印了<code>Hello World Start</code>的语句。  </p>
<img src="/images/post/2015-1/felix_idea_running_2.png" class="">  
<p>输入<code>lb</code>查看所有bundle的信息，可以看到最下面是我们的bundle，已经激活。</p>
<img src="/images/post/2015-1/felix_idea_running_3.png" class="">  
<p>我们停掉bundle，再显示所有bundle状态，可以看到我们的bundle的状态已经是<code>Resolved</code>了。</p>
<img src="/images/post/2015-1/felix_idea_running_4.png" class="">  
<h2 id="使用felix的Maven-Bundle插件来创建bundle"><a href="#使用felix的Maven-Bundle插件来创建bundle" class="headerlink" title="使用felix的Maven Bundle插件来创建bundle"></a>使用felix的Maven Bundle插件来创建bundle</h2><p>上面是通过IDE来启动和创建bundle，我们再来看下使用felix maven插件的方式创建bundle，这里是官网地址说明: <a target="_blank" rel="noopener" href="http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html">http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html</a>。  </p>
<ul>
<li>首先新建Maven的pom.xml文件<ul>
<li>在dependencies加入felix的jar包，最新的版本是1.4.0</li>
<li>在plugin中定义我们的bundle，包括我们的Activator等信息。</li>
<li>packaging需要修改为<code>bundle</code></li>
</ul>
</li>
</ul>
<figure class="highlight xml"><figcaption><span>pom.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>osgi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>bundle<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-bundle-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">extensions</span>&gt;</span>true<span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">instructions</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Bundle-SymbolicName</span>&gt;</span>$&#123;pom.groupId&#125;.$&#123;pom.artifactId&#125;<span class="tag">&lt;/<span class="name">Bundle-SymbolicName</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Bundle-Vendor</span>&gt;</span>Apache Felix<span class="tag">&lt;/<span class="name">Bundle-Vendor</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Bundle-Activator</span>&gt;</span>com.zzm.osgi.HelloActivator<span class="tag">&lt;/<span class="name">Bundle-Activator</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Private-Package</span>&gt;</span>com.zzm.osgi<span class="tag">&lt;/<span class="name">Private-Package</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">instructions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.osgi.core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure> 
<ul>
<li>还是使用我们之前的Activator，在工程根目录下使用maven进行打包，打包完后可以在target目录下面看到打好的bundle包。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ mvn clean install</span><br><span class="line">...balabala</span><br><span class="line"></span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-bundle-plugin:2.4.0:bundle (default-bundle) @ osgi ---</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-install-plugin:2.5.2:install (default-install) @ osgi ---</span><br><span class="line">[INFO] Installing /Users/zhaozhiming/projects/hello_osgi/bundles/osgi-1.0-SNAPSHOT.jar to /Users/zhaozhiming/.m2/repository/com/zzm/osgi/1.0-SNAPSHOT/osgi-1.0-SNAPSHOT.jar</span><br><span class="line">[INFO] Installing /Users/zhaozhiming/projects/hello_osgi/pom.xml to /Users/zhaozhiming/.m2/repository/com/zzm/osgi/1.0-SNAPSHOT/osgi-1.0-SNAPSHOT.pom</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-bundle-plugin:2.4.0:install (default-install) @ osgi ---</span><br><span class="line">[INFO] Installing com/zzm/osgi/1.0-SNAPSHOT/osgi-1.0-SNAPSHOT.jar</span><br><span class="line">[INFO] Writing OBR metadata</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 3.898s</span><br><span class="line">[INFO] Finished at: Sat Jan 31 10:44:49 HKT 2015</span><br><span class="line">[INFO] Final Memory: 18M/216M</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> target</span><br><span class="line">$ <span class="built_in">ls</span> -l</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x  4 zhaozhiming  staff   136 Jan 31 10:57 classes</span><br><span class="line">drwxr-xr-x  3 zhaozhiming  staff   102 Jan 31 10:57 maven-status</span><br><span class="line">-rw-r--r--  1 zhaozhiming  staff  2901 Jan 31 10:57 osgi-1.0-SNAPSHOT.jar</span><br><span class="line">drwxr-xr-x  4 zhaozhiming  staff   136 Jan 31 10:57 surefire-reports</span><br><span class="line">drwxr-xr-x  3 zhaozhiming  staff   102 Jan 31 10:57 test-classes</span><br><span class="line"></span><br></pre></td></tr></table></figure> 
<ul>
<li>打完包后，在target&#x2F;classes&#x2F;META-INF目录下，可以看到maven会产生一个MANIFEST.MF文件，显示了bundle的具体信息。</li>
</ul>
<figure class="highlight sh"><figcaption><span>MANIFEST.MF</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Bnd-LastModified: 1422673028905</span><br><span class="line">Build-Jdk: 1.8.0_25</span><br><span class="line">Built-By: zhaozhiming</span><br><span class="line">Bundle-Activator: com.zzm.osgi.HelloActivator</span><br><span class="line">Bundle-ManifestVersion: 2</span><br><span class="line">Bundle-Name: osgi</span><br><span class="line">Bundle-SymbolicName: com.zzm.osgi</span><br><span class="line">Bundle-Vendor: Apache Felix</span><br><span class="line">Bundle-Version: 1.0.0.SNAPSHOT</span><br><span class="line">Created-By: Apache Maven Bundle Plugin</span><br><span class="line">Export-Package: com.zzm.osgi;uses:=<span class="string">&quot;org.osgi.framework&quot;</span>;version=<span class="string">&quot;1.0.0.S</span></span><br><span class="line"><span class="string"> NAPSHOT&quot;</span></span><br><span class="line">Import-Package: org.osgi.framework;version=<span class="string">&quot;[1.5,2)&quot;</span></span><br><span class="line">Tool: Bnd-2.1.0.20130426-122213</span><br></pre></td></tr></table></figure> 
<ul>
<li>在felix中运行bundle</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝bundle包</span></span><br><span class="line">$ <span class="built_in">cp</span> osgi-1.0-SNAPSHOT.jar /your/felix/parent/folder</span><br><span class="line">$ <span class="built_in">cd</span> /your/felix/parent/folder</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">drwxr-xr-x@ 12 zhaozhiming  staff   408 Jan 30 13:39 felix</span><br><span class="line">-rw-r--r--   1 zhaozhiming  staff  2901 Jan 31 11:18 osgi-1.0-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动felix</span></span><br><span class="line">$ <span class="built_in">cd</span> felix</span><br><span class="line">$ java -jar bin/felix.jar</span><br><span class="line">____________________________</span><br><span class="line">Welcome to Apache Felix Gogo</span><br><span class="line"></span><br><span class="line">g! </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有bundle</span></span><br><span class="line">g! lb</span><br><span class="line">START LEVEL 1</span><br><span class="line">   ID|State      |Level|Name</span><br><span class="line">    0|Active     |    0|System Bundle (4.6.0)</span><br><span class="line">    1|Active     |    1|Apache Felix Bundle Repository (2.0.2)</span><br><span class="line">    2|Active     |    1|Apache Felix Gogo Command (0.14.0)</span><br><span class="line">    3|Active     |    1|Apache Felix Gogo Runtime (0.12.1)</span><br><span class="line">    4|Active     |    1|Apache Felix Gogo Shell (0.10.0)</span><br><span class="line">    5|Active     |    1|Sample01 (1.0.0.SNAPSHOT)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装我们的bundle</span></span><br><span class="line">g! install file:../osgi-1.0-SNAPSHOT.jar</span><br><span class="line">Bundle ID: 253</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看bundle信息</span></span><br><span class="line">g! lb</span><br><span class="line">START LEVEL 1</span><br><span class="line">   ID|State      |Level|Name</span><br><span class="line">   ...</span><br><span class="line">  253|Installed  |    1|osgi (1.0.0.SNAPSHOT)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 启动我们的bundle</span></span><br><span class="line">g! start 253</span><br><span class="line">Hello World Bundle start!</span><br><span class="line">g! lb  </span><br><span class="line">START LEVEL 1</span><br><span class="line">   ID|State      |Level|Name</span><br><span class="line">    ...</span><br><span class="line">  253|Active     |    1|osgi (1.0.0.SNAPSHOT)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停掉我们的bundle</span></span><br><span class="line">g! stop 253</span><br><span class="line">Hello World Bundle stop!</span><br><span class="line">g! lb</span><br><span class="line">START LEVEL 1</span><br><span class="line">   ID|State      |Level|Name</span><br><span class="line">   ...</span><br><span class="line">  253|Resolved   |    1|osgi (1.0.0.SNAPSHOT)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载我们的bundle，可以看到已经没有出现在所有bundle信息中了</span></span><br><span class="line">g! uninstall 253</span><br><span class="line">g! lb</span><br><span class="line">START LEVEL 1</span><br><span class="line">   ID|State      |Level|Name</span><br><span class="line">    0|Active     |    0|System Bundle (4.6.0)</span><br><span class="line">    1|Active     |    1|Apache Felix Bundle Repository (2.0.2)</span><br><span class="line">    2|Active     |    1|Apache Felix Gogo Command (0.14.0)</span><br><span class="line">    3|Active     |    1|Apache Felix Gogo Runtime (0.12.1)</span><br><span class="line">    4|Active     |    1|Apache Felix Gogo Shell (0.10.0)</span><br><span class="line">    5|Active     |    1|Sample01 (1.0.0.SNAPSHOT)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最后`ctl+c`退出felix</span></span><br></pre></td></tr></table></figure> 
<h2 id="在bundle中添加第三方包"><a href="#在bundle中添加第三方包" class="headerlink" title="在bundle中添加第三方包"></a>在bundle中添加第三方包</h2><p>在bundle中使用第三方包比较麻烦，查看了各方资料，只找到了把第三方jar包一起打进bundle的方法，我们以引入<a target="_blank" rel="noopener" href="https://code.google.com/p/guava-libraries/"><code>guava</code></a>包为例，下面代码加注释的就是修改的地方。 </p>
<figure class="highlight xml"><figcaption><span>pom.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>osgi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>bundle<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-bundle-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">extensions</span>&gt;</span>true<span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--修改bundle配置  --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">instructions</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Bundle-SymbolicName</span>&gt;</span>$&#123;pom.groupId&#125;.$&#123;pom.artifactId&#125;<span class="tag">&lt;/<span class="name">Bundle-SymbolicName</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Bundle-Vendor</span>&gt;</span>Apache Felix<span class="tag">&lt;/<span class="name">Bundle-Vendor</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Bundle-Activator</span>&gt;</span>com.zzm.osgi.HelloActivator<span class="tag">&lt;/<span class="name">Bundle-Activator</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Private-Package</span>&gt;</span>com.zzm.osgi<span class="tag">&lt;/<span class="name">Private-Package</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Embed-Dependency</span>&gt;</span></span><br><span class="line">                            *;scope=compile|runtime;inline=false</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">Embed-Dependency</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">_exportcontents</span>&gt;</span>*<span class="tag">&lt;/<span class="name">_exportcontents</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Bundle-ClassPath</span>&gt;</span>.,&#123;maven-dependencies&#125;<span class="tag">&lt;/<span class="name">Bundle-ClassPath</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Embed-Transitive</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Embed-Transitive</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Embed-Directory</span>&gt;</span>jars<span class="tag">&lt;/<span class="name">Embed-Directory</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Embed-StripGroup</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Embed-StripGroup</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">_failok</span>&gt;</span>true<span class="tag">&lt;/<span class="name">_failok</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">_nouses</span>&gt;</span>true<span class="tag">&lt;/<span class="name">_nouses</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">instructions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 添加依赖包copy插件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>jars<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.osgi.core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 在pom中添加guava依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>18.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure> 
<ul>
<li>在Activator中添加guava的代码</li>
</ul>
<figure class="highlight java"><figcaption><span>HelloActivator.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloActivator</span> <span class="keyword">implements</span> <span class="title class_">BundleActivator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(BundleContext bundleContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World Bundle start!&quot;</span>);</span><br><span class="line">        List&lt;String&gt; strings = Lists.newArrayList(<span class="string">&quot;I&quot;</span>, <span class="string">&quot;use&quot;</span>, <span class="string">&quot;guava&quot;</span>, <span class="string">&quot;here&quot;</span>);</span><br><span class="line">        System.out.println(strings);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure> 
<ul>
<li>打包运行我们的bundle</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ mvn clean install </span><br><span class="line">$ <span class="built_in">cp</span> osgi-1.0-SNAPSHOT.jar /your/felix/parent/folder</span><br><span class="line">$ <span class="built_in">cd</span> /your/felix/parent/folder</span><br><span class="line">$ java -jar bin/felix.jar</span><br><span class="line">____________________________</span><br><span class="line">Welcome to Apache Felix Gogo</span><br><span class="line"></span><br><span class="line">g! install file:../osgi-1.0-SNAPSHOT.jar</span><br><span class="line">Bundle ID: 258</span><br><span class="line">g! start 258</span><br><span class="line">Hello World Bundle start!</span><br><span class="line">[I, use, guava, here]</span><br></pre></td></tr></table></figure> 
<ul>
<li>可以解压我们的bundle jar包看一下结构</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> jar_tar</span><br><span class="line">$ <span class="built_in">cp</span> osgi-1.0-SNAPSHOT.jar jar_tar/</span><br><span class="line">$ <span class="built_in">cd</span> jar_tar/</span><br><span class="line">$ tar -xvf osgi-1.0-SNAPSHOT.jar</span><br><span class="line">$ <span class="built_in">ls</span> -l <span class="comment"># 可以看到有个jars的文件夹</span></span><br><span class="line">drwxr-xr-x  4 zhaozhiming  staff      136 Jan 31 11:56 META-INF</span><br><span class="line">drwxr-xr-x  3 zhaozhiming  staff      102 Jan 31 11:44 com</span><br><span class="line">drwxr-xr-x  3 zhaozhiming  staff      102 Jan 31 11:44 jars</span><br><span class="line">-rw-r--r--  1 zhaozhiming  staff  1998876 Jan 31 11:55 osgi-1.0-SNAPSHOT.jar</span><br><span class="line">$ <span class="built_in">ls</span> -l jars <span class="comment"># jars里面是我们的第三方包</span></span><br><span class="line">-rwxr-xr-x  1 zhaozhiming  staff  2256213 Jan 30 10:07 guava-18.0.jar</span><br></pre></td></tr></table></figure> 

<ul>
<li>再看一下MANIFEST.MF文件，如下所示。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Bnd-LastModified: 1422675843327</span><br><span class="line">Build-Jdk: 1.8.0_25</span><br><span class="line">Built-By: zhaozhiming</span><br><span class="line">Bundle-Activator: com.zzm.osgi.HelloActivator</span><br><span class="line">Bundle-ClassPath: .,jars/guava-18.0.jar</span><br><span class="line">Bundle-ManifestVersion: 2</span><br><span class="line">Bundle-Name: osgi</span><br><span class="line">Bundle-SymbolicName: com.zzm.osgi</span><br><span class="line">Bundle-Vendor: Apache Felix</span><br><span class="line">Bundle-Version: 1.0.0.SNAPSHOT</span><br><span class="line">Created-By: Apache Maven Bundle Plugin</span><br><span class="line">Embed-Dependency: *;scope=compile|runtime;inline=<span class="literal">false</span></span><br><span class="line">Embed-Directory: jars</span><br><span class="line">Embed-StripGroup: <span class="literal">true</span></span><br><span class="line">Embed-Transitive: <span class="literal">true</span></span><br><span class="line">Embedded-Artifacts: jars/guava-18.0.jar;g=<span class="string">&quot;com.google.guava&quot;</span>;a=<span class="string">&quot;guava&quot;</span>;v</span><br><span class="line"> =<span class="string">&quot;18.0&quot;</span></span><br><span class="line">Export-Package: com.google.common.annotations;version=<span class="string">&quot;18.0.0&quot;</span>,com.googl</span><br><span class="line"> e.common.base;version=<span class="string">&quot;18.0.0&quot;</span>,com.google.common.base.internal;version=</span><br><span class="line"> <span class="string">&quot;1.0.0.SNAPSHOT&quot;</span>,com.google.common.cache;version=<span class="string">&quot;18.0.0&quot;</span>,com.google.co</span><br><span class="line"> mmon.collect;version=<span class="string">&quot;18.0.0&quot;</span>,com.google.common.escape;version=<span class="string">&quot;18.0.0&quot;</span></span><br><span class="line"> ,com.google.common.eventbus;version=<span class="string">&quot;18.0.0&quot;</span>,com.google.common.hash;ver</span><br><span class="line"> sion=<span class="string">&quot;18.0.0&quot;</span>,com.google.common.html;version=<span class="string">&quot;18.0.0&quot;</span>,com.google.common</span><br><span class="line"> .io;version=<span class="string">&quot;18.0.0&quot;</span>,com.google.common.math;version=<span class="string">&quot;18.0.0&quot;</span>,com.google</span><br><span class="line"> .common.net;version=<span class="string">&quot;18.0.0&quot;</span>,com.google.common.primitives;version=<span class="string">&quot;18.0</span></span><br><span class="line"><span class="string"> .0&quot;</span>,com.google.common.reflect;version=<span class="string">&quot;18.0.0&quot;</span>,com.google.common.util.c</span><br><span class="line"> oncurrent;version=<span class="string">&quot;18.0.0&quot;</span>,com.google.common.xml;version=<span class="string">&quot;18.0.0&quot;</span>,com.g</span><br><span class="line"> oogle.thirdparty.publicsuffix;version=<span class="string">&quot;1.0.0.SNAPSHOT&quot;</span>,com.zzm.osgi;ver</span><br><span class="line"> sion=<span class="string">&quot;1.0.0.SNAPSHOT&quot;</span>,jars;version=<span class="string">&quot;1.0.0.SNAPSHOT&quot;</span></span><br><span class="line">Import-Package: javax.annotation,org.osgi.framework;version=<span class="string">&quot;[1.5,2)&quot;</span>,su</span><br><span class="line"> n.misc</span><br><span class="line">Tool: Bnd-2.1.0.20130426-122213</span><br></pre></td></tr></table></figure> 
<p><code>PS</code>:在Import-Package中有sun.misc的字样，表示bundle引入了jdk的一些包，有时候在运行bundle的时候会看到下面的错误:  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.osgi.framework.BundleException: Unresolved constraint <span class="keyword">in</span> bundle [8]: Unable to resolve 8.0: missing requirement [8.0] osgi.wiring.package; (osgi.wiring.package=sun.misc)</span><br></pre></td></tr></table></figure> 
<p>解决办法有2个，执行解决办法意味着你清楚并明确运行bundle时可以缺少这些包:   </p>
<p>way1:是在pom文件中的<Import-Package>中加入!sum.misc，这样打出来的MANIFEST.MF的Import-Package就不会有sun.misc字样了。  </p>
<figure class="highlight xml"><figcaption><span>pom.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Bundle-SymbolicName</span>&gt;</span>$&#123;project.groupId&#125;.$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">Bundle-SymbolicName</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Bundle-Vendor</span>&gt;</span>joyotime<span class="tag">&lt;/<span class="name">Bundle-Vendor</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Bundle-Version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">Bundle-Version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Bundle-Activator</span>&gt;</span>com.morewifi.chinatelecom.MoreWifiActivator<span class="tag">&lt;/<span class="name">Bundle-Activator</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Private-Package</span>&gt;</span>com.morewifi.chinatelecom<span class="tag">&lt;/<span class="name">Private-Package</span>&gt;</span></span><br><span class="line">   ...</span><br><span class="line">   <span class="tag">&lt;<span class="name">Import-Package</span>&gt;</span></span><br><span class="line">       !sun.misc,*</span><br><span class="line">   <span class="tag">&lt;/<span class="name">Import-Package</span>&gt;</span></span><br></pre></td></tr></table></figure> 
<p>way2:在felix解压包下有个conf&#x2F;config.properties文件，在里面配置缺少的包。</p>
<figure class="highlight properties"><figcaption><span>felix/conf/config.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.osgi.framework.system.packages.extra</span>=<span class="string">sun.misc</span></span><br></pre></td></tr></table></figure> 
<h2 id="在bundle中保存文件"><a href="#在bundle中保存文件" class="headerlink" title="在bundle中保存文件"></a>在bundle中保存文件</h2><p>有时候在bundle中需要写一些数据到文件保存起来，可以使用<code>bundleContext</code>的<code>getDataFile</code>方法来获取文件，下面代码使用了guava的io方法。  </p>
<figure class="highlight java"><figcaption><span>HelloActivator.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloActivator</span> <span class="keyword">implements</span> <span class="title class_">BundleActivator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(BundleContext bundleContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World Bundle start!&quot;</span>);</span><br><span class="line">        List&lt;String&gt; strings = Lists.newArrayList(<span class="string">&quot;I&quot;</span>, <span class="string">&quot;use&quot;</span>, <span class="string">&quot;guava&quot;</span>, <span class="string">&quot;here&quot;</span>);</span><br><span class="line">        System.out.println(strings);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dataFile</span> <span class="operator">=</span> bundleContext.getDataFile(<span class="string">&quot;save.txt&quot;</span>);</span><br><span class="line">        Files.append(strings.toString(), dataFile, Charsets.UTF_8);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取文件</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileContent</span> <span class="operator">=</span> Files.readFirstLine(dataFile, Charsets.UTF_8);</span><br><span class="line">        System.out.println(fileContent);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure> 
<p>打印结果如下:  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">g! start 263</span><br><span class="line">Hello World Bundle start!</span><br><span class="line">[I, use, guava, here]</span><br><span class="line">[I, use, guava, here]</span><br></pre></td></tr></table></figure> 
<p>在felix的目录下，有个felix-cache目录，下面是各个bundle对应的文件夹，我们的save.txt就存放在bundle的data文件夹里面。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> felix-cache/bundle263/</span><br><span class="line">$ <span class="built_in">ls</span> -l </span><br><span class="line">-rw-r--r--  1 zhaozhiming  staff   54 Jan 31 13:51 bundle.info</span><br><span class="line">drwxr-xr-x  3 zhaozhiming  staff  102 Jan 31 13:50 data</span><br><span class="line">drwxr-xr-x  5 zhaozhiming  staff  170 Jan 31 13:50 version0.0</span><br><span class="line">$ <span class="built_in">ls</span> -l data</span><br><span class="line">-rw-r--r--  1 zhaozhiming  staff  21 Jan 31 13:50 save.txt</span><br><span class="line">$ <span class="built_in">cat</span> data/save.txt </span><br><span class="line">[I, use, guava, here]</span><br></pre></td></tr></table></figure> 
</div>

</article>
<section id="appreciates">
  <center>
	<h2>赞赏</h2>
    <div class="post-footer">
      <div>
	    <h4>如果文章对您有所帮助，可以捐赠我喝杯咖啡😌，捐赠方式：</h4>
        <div class="digital-wallet">
          <h6>BTC 地址：3LYgSyf7ddMALwGWPQr3PY4wzjsTDdg1oV</h6>
          <h6>ETH 地址：0x0C9b27c89A61aadb0aEC24CA8949910Cbf77Aa73</h6>
        </div>
        <div class="wechat_appreciates">
          <img src="/images/wechat_appreciates.png" alt="qrcode" width="250" >
        </div>
      </div>
      <div>
	    <h4>文章已同步更新公众号，欢迎关注</h4>
        <div class="wechat_appreciates">
          <img src="/images/wxgzh_qrcode.jpg" alt="qrcode" width="250" >
        </div>
      </div>
    </div>
  </center>
</section>



    
      <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = 'https://zhaozhiming.github.io/2015/01/25/hello-osgi/';
            this.page.identifier = 'https://zhaozhiming.github.io/2015/01/25/hello-osgi/';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//zhaozhiming.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

</div>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2025

    赵芝明
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a target="_blank" rel="noopener" href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a target="_blank" rel="noopener" href="http://github.com/panks/fabric">fabric</a> by <a target="_blank" rel="noopener" href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5608723650603289" crossorigin="anonymous"></script>
</body>
</html>
