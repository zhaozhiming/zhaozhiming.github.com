<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>基于 Expo 的 React Native 消息推送 - Hacker and Geeker&#39;s Way</title>
    <meta name="author" content="">
    
	<meta name="description" content="基于 Expo 的 React Native 消息推送"> <!-- TODO: truncate -->
	<meta name="keywords" content="expo,react native,push notification,local notification">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="Hacker and Geeker&#39;s Way" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='/stylesheets/font.css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/font.css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/font.css?family=Amethysta+One' rel='stylesheet' type='text/css'>
	  <script src="/javascripts/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-100485541-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


<meta name="generator" content="Hexo 6.3.0"></head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Hacker and Geeker&#39;s Way
    </div>
</h1>
<span class="subtitle"></span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a target="_blank" rel="noopener" href="https://github.com/zhaozhiming" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a target="_blank" rel="noopener" href="http://www.twitter.com/kingzzm" class="twitter" title="Twitter"></a>
  </li>
  
  
  <!-- LinkedIn -->
  <li>
  <a target="_blank" rel="noopener" href="http://www.linkedin.com/in/zhaozhiming" class="linkedin" title="LinkedIn"></a>
  </li>
  
  
  
  
  
  <!-- Stackoverflow -->
  <li>
  <a target="_blank" rel="noopener" href="http://stackoverflow.com/users/1954315/zhaozhiming" class="stackoverflow" title="Stackoverflow"></a>
  </li>
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    <li><a href="/about/index.html">About</a></li>
    
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="https://zhaozhiming.github.io" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>


<div id="toload">
<!-- begin toload -->
    <div id="content">
        <div class="inner">
<article class="post">
	<h2 class="title">基于 Expo 的 React Native 消息推送</h2>
    <div class="meta">
        <div class="date">Published on: <time datetime="2018-05-06T06:49:00.000Z" itemprop="datePublished">5月 6, 2018</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/expo/">expo</a> <a href="/tags/react-native/">react native</a> <a href="/tags/push-notification/">push notification</a> <a href="/tags/local-notification/">local notification</a>
</div>
    </div>
	<div class="entry-content"><img src="/images/post/2018/05/notification.jpg" class="" width="400" height="300">

<p><a target="_blank" rel="noopener" href="https://expo.io/">Expo</a> 是 <a target="_blank" rel="noopener" href="https://facebook.github.io/react-native/">React Native</a> 开发的一个神器，正如 Expo 官网上所说，Expo 之于 React Native 就像 Rails 之于 Ruby，它提供了很多超越原生 React Native API 的功能，包括二维码扫描、存储、内部浏览器等，甚至还可以使用 Expo 进行 APP 的打包，完全不需要使用 XCode 和 Android Studio。</p>
<p>而消息推送则是 APP 应用非常常见的一个功能，今天就来介绍一下基于 Expo 的 React Native 消息推送功能是如何开发的吧。</p>
<span id="more"></span>

<p>APP 的消息推送一般有两种形式，一种是本地消息，比如 APP 中有个定时执行的任务，完成后给用户发送一个”任务执行完成”的通知；另外一种是远程消息，比如说某个电商做活动，会向用户推送一些活动相关的消息。</p>
<p>本地和远程消息两者本质的区别就是：本地消息是由 APP 本身发送的，而远程消息是由 APP 的后端（服务端）发送的。</p>
<h2 id="本地消息推送"><a href="#本地消息推送" class="headerlink" title="本地消息推送"></a>本地消息推送</h2><p>本地消息不需要和服务端交互，相对比较简单，让我们先来看看 Expo 的本地消息是如何发送的。</p>
<h3 id="消息对象"><a href="#消息对象" class="headerlink" title="消息对象"></a>消息对象</h3><p>一般我们手机上收到的推送消息大概是下面这样子，有 APP 的 Icon、标题、摘要信息以及推送的时间。</p>
<img src="/images/post/2018/05/notification_demo.png" class="">

<p>所以我们需要先构造一个本地消息对象，它主要包含以下属性：</p>
<ul>
<li>title：字符串类型，必填属性，消息的标题，会显示在手机的通知栏上面</li>
<li>body：字符串类型，必填属性，消息的摘要信息，会显示在手机的通知栏上面</li>
<li>data：对象类型，可选属性，附加在消息上的一个数据对象，不会显示在通知栏上，但可在 APP 内部使用该对象。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> localNotification = &#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;Test&#x27;</span>,</span><br><span class="line">  <span class="attr">body</span>: <span class="string">&#x27;This is a Test&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">foo</span>: <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h3><p>创建好了消息对象后，我们就可以来尝试将它发送，Expo 提供了两种发送方式：立即发送和定时发送。</p>
<h4 id="立即发送"><a href="#立即发送" class="headerlink" title="立即发送"></a>立即发送</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Notifications</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;expo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Notifications</span>.<span class="title function_">presentLocalNotificationAsync</span>(localNotification);</span><br></pre></td></tr></table></figure>

<p>调用这个方法后 APP 会马上发送一条消息，然后在手机通知栏上就可以看到。</p>
<h4 id="定时发送"><a href="#定时发送" class="headerlink" title="定时发送"></a>定时发送</h4><p>定时发送除了要求消息对象外，还需要时间调度的对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Notifications</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;expo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> schedulingOptions = &#123;</span><br><span class="line">  <span class="attr">time</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="number">1000</span> <span class="comment">// 表示一秒后发送消息</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">Notifications</span>.<span class="title function_">scheduleLocalNotificationAsync</span>(localNotification, schedulingOptions);</span><br></pre></td></tr></table></figure>

<p>上面的示例中会在 1 秒后发送消息，<code>schedulingOptions</code> 的有如下属性：</p>
<ul>
<li>time：可以是 Date 对象，也可以是时间毫秒数，表示什么时候开始发送消息</li>
<li>repeat：字符串，可以填的值有<code>&#39;minute&#39;、&#39;hour&#39;、&#39;day&#39;、&#39;week&#39;、&#39;month&#39;、&#39;year&#39;</code>，表示是否重复发送消息</li>
</ul>
<h2 id="远程消息推送"><a href="#远程消息推送" class="headerlink" title="远程消息推送"></a>远程消息推送</h2><p>远程消息的发送稍微复杂一些，需要搭建自己的后台服务，流程图如下：</p>
<img src="/images/post/2018/05/push-notification.png" class="">

<ul>
<li>手机通过后台服务提供的 API 进行设备登记</li>
<li>后台服务调用 Expo 后台服务的 API</li>
<li>Expo 后台服务往所有登记过的设备上推送消息</li>
</ul>
<p>下面我们来详细看下每一步的具体操作。</p>
<h3 id="后台服务"><a href="#后台服务" class="headerlink" title="后台服务"></a>后台服务</h3><p>我们需要搭建自己的后台服务来提供 API，API 要做的事情就是接收请求中的设备号并保存起来，下面我们用<code>Node.js</code>来写个简单的 API 示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Set 来保存手机设备号，这样保证每个设备号只有一个</span></span><br><span class="line"><span class="comment">// 这里只是简单示例，更好的方案是用数据库保存设备号</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PUSH_TOKENS</span> = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line"><span class="comment">// 这里使用的是 [Hapi](https://hapijs.com/) 框架</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">register</span> = <span class="function">(<span class="params">server, options, next</span>) =&gt;</span> &#123;</span><br><span class="line">  server.<span class="title function_">route</span>([</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/users/push-token&#x27;</span>,</span><br><span class="line">      <span class="attr">config</span>: &#123;</span><br><span class="line">        <span class="attr">handler</span>: <span class="function">(<span class="params">request, reply</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// token 为请求参数中的设备号</span></span><br><span class="line">          <span class="keyword">const</span> &#123; token &#125; = request.<span class="property">payload</span>;</span><br><span class="line">          <span class="comment">// 添加到 Set 中</span></span><br><span class="line">          pushTokens.<span class="title function_">add</span>(token);</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">reply</span>(&#123; <span class="attr">message</span>: <span class="string">`The tokens is <span class="subst">$&#123;token&#125;</span>`</span> &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ]);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>例子非常简单，这里提供了一个方法为<code>POST</code>，url 为<code>/users/push-token</code>的 API，请求中必须带有 token 参数。</p>
<h3 id="登记设备"><a href="#登记设备" class="headerlink" title="登记设备"></a>登记设备</h3><p>准备好了 API 之后，我们就可以在设备上调用 API 进行设备登记了。</p>
<p>Expo 在<code>Notifications</code>模块中提供了相应的方法来让获取设备号，我们来看一下示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Permissions</span>, <span class="title class_">Notifications</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;expo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getToken</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 首先要获取手机允许接收消息的权限</span></span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">status</span>: existingStatus &#125; = <span class="keyword">await</span> <span class="title class_">Permissions</span>.<span class="title function_">getAsync</span>(</span><br><span class="line">    <span class="title class_">Permissions</span>.<span class="property">NOTIFICATIONS</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">let</span> finalStatus = existingStatus;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果没有授权则发请求获取</span></span><br><span class="line">  <span class="keyword">if</span> (existingStatus !== <span class="string">&#x27;granted&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status &#125; = <span class="keyword">await</span> <span class="title class_">Permissions</span>.<span class="title function_">askAsync</span>(<span class="title class_">Permissions</span>.<span class="property">NOTIFICATIONS</span>);</span><br><span class="line">    finalStatus = status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用户不允许则返回空</span></span><br><span class="line">  <span class="keyword">if</span> (finalStatus !== <span class="string">&#x27;granted&#x27;</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用 Expo API 来获取设备号</span></span><br><span class="line">  <span class="keyword">const</span> token = <span class="keyword">await</span> <span class="title class_">Notifications</span>.<span class="title function_">getExpoPushTokenAsync</span>();</span><br><span class="line">  <span class="keyword">return</span> token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拿到设备号后，我们就可以将设备号发送到我们的后台服务了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">PUSH_ENDPOINT</span> = <span class="string">&#x27;https://your-server.com/users/push-token&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">pushToken</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 通过 POST 请求将设备号发送到后台服务</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="variable constant_">PUSH_ENDPOINT</span>, &#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">      <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="title class_">Accept</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; token &#125;),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`发送设备号异常：<span class="subst">$&#123;e.message&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="发送消息"><a href="#发送消息" class="headerlink" title="发送消息"></a>发送消息</h3><p>最后一步是让 Expo 的后台服务将消息推送给登记过的所有设备，那我们要怎么发送请求给 Expo 的后台服务呢？</p>
<p>其实 Expo 提供了 sdk 包来让我们的后台服务可以与 Expo 的服务器进行通信，sdk 包支持多种语言，方便与各种 Web 服务集成，支持的语言包括<code>Node.js</code>、<code>Python</code>、<code>Ruby</code>、<code>PHP</code>、<code>Golang</code>等，我们以<code>Node.js</code>为例介绍一下我们的后台服务是如何与 Expo 后台服务进行通信的：</p>
<ul>
<li>首先是要添加 Expo 的 sdk 包</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add expo-server-sdk</span><br></pre></td></tr></table></figure>

<ul>
<li>接着调用 Expo 的 API 进行消息推送，下面是示例代码，可以看注释理解相应的代码：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Expo</span> <span class="keyword">from</span> <span class="string">&#x27;expo-server-sdk&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 Expo 客户端实例</span></span><br><span class="line"><span class="keyword">let</span> expo = <span class="keyword">new</span> <span class="title class_">Expo</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建要发送的消息</span></span><br><span class="line"><span class="keyword">let</span> messages = [];</span><br><span class="line"><span class="comment">// 往所有设备推送消息</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> pushToken <span class="keyword">of</span> somePushTokens) &#123;</span><br><span class="line">  <span class="comment">// 设备号的格式为：ExponentPushToken[xxxxxxxxxxxxxxxxxxxxxx]</span></span><br><span class="line">  <span class="comment">// 检查每个设备号格式是否正确</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title class_">Expo</span>.<span class="title function_">isExpoPushToken</span>(pushToken)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Push token <span class="subst">$&#123;pushToken&#125;</span> is not a valid Expo push token`</span>);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造消息对象</span></span><br><span class="line">  messages.<span class="title function_">push</span>(&#123;</span><br><span class="line">    <span class="attr">to</span>: pushToken,</span><br><span class="line">    <span class="attr">sound</span>: <span class="string">&#x27;default&#x27;</span>,</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&#x27;This is a test notification&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: &#123; <span class="attr">withSome</span>: <span class="string">&#x27;data&#x27;</span> &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将消息转换成块，这样同样内容的消息会进行压缩，Expo 支持且推荐批量推送消息</span></span><br><span class="line"><span class="keyword">let</span> chunks = expo.<span class="title function_">chunkPushNotifications</span>(messages);</span><br><span class="line"></span><br><span class="line">(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 分批发送消息</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> chunk <span class="keyword">of</span> chunks) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> receipts = <span class="keyword">await</span> expo.<span class="title function_">sendPushNotificationsAsync</span>(chunk);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(receipts);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>这样就完成了一次远程消息的推送。</p>
<h2 id="消息接收"><a href="#消息接收" class="headerlink" title="消息接收"></a>消息接收</h2><p>当消息发送到手机上的时候，APP 要如何进行消息接收呢？Expo 提供了一个消息监听器，不管是本地的还是远程的消息都可以监听到，我们来看一段简单的代码示例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Notifications</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;expo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">AppContainer</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">notification</span>: &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 推荐在`componentDidMount`生命周期中添加消息监听器</span></span><br><span class="line">    <span class="comment">// 消息的处理方法作为参数传入`Notifications.addListener`方法中</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">notificationSubscription</span> = <span class="title class_">Notifications</span>.<span class="title function_">addListener</span>(<span class="variable language_">this</span>.<span class="property">handleNotification</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleNotification = <span class="function">(<span class="params">notification</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 这里我们简单地将接收到的消息保存到组件的 state 中</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">notification</span>: notification&#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="notification-对象"><a href="#notification-对象" class="headerlink" title="notification 对象"></a>notification 对象</h3><p>在<code>handleNotification</code>方法中我们会对接收消息进行处理，<code>notification</code>就是接收的消息对象，它有如下属性：</p>
<ul>
<li>remote：<code>true</code>表示这个消息是远程消息，<code>false</code>则是本地消息</li>
<li>origin：这个属性有 2 个值——<code>selected</code>和<code>received</code>。<code>selected</code>表示是用户从通知栏上点击消息而接收到的，而<code>received</code>则表示是 APP 在打开状态时接收到的。</li>
<li>data：附加在消息上的 data 对象</li>
</ul>
<h3 id="EventSubscription-对象"><a href="#EventSubscription-对象" class="headerlink" title="EventSubscription 对象"></a>EventSubscription 对象</h3><p>调用<code>Notifications.addListener</code>后返回的<code>notificationSubscription</code> 是一个<code>EventSubscription</code>对象，它有以下属性和方法：</p>
<ul>
<li>remove()：该方法可以用来取消已有的监听器</li>
<li>origin：同<code>notification </code>对象的<code>origin</code>属性</li>
<li>remote：同<code>notification </code>对象的<code>remote</code>属性</li>
<li>data：同<code>notification </code>对象的<code>data</code>属性</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>消息推送是 APP 的常见需求，市面上也有不少解决方案，但 Expo 相对其他解决方案来说最大的优势就是无需与原生的模块打交道，比如其他消息推送方案可能需要对 android 的源文件进行修改，然后再对 ios 的源文件进行修改，而 Expo 则不需要关心这些，只要在 React Native 中写好代码就可以了。唯一的不足就是需要搭建自己的后台服务，但如果你的 APP 本身就带有后台服务的话，则 Expo 的消息推送方案是你的首要选择。</p>
</div>

</article>
<section id="appreciates">
  <center>
	<h2>赞赏</h2>
    <div class="post-footer">
      <div>
	    <h4>如果文章对您有所帮助，可以捐赠我喝杯咖啡😌，捐赠方式：</h4>
        <div class="digital-wallet">
          <h6>BTC 地址：3LYgSyf7ddMALwGWPQr3PY4wzjsTDdg1oV</h6>
          <h6>ETH 地址：0x0C9b27c89A61aadb0aEC24CA8949910Cbf77Aa73</h6>
        </div>
        <div class="wechat_appreciates">
          <img src="/images/wechat_appreciates.png" alt="qrcode" width="250" >
        </div>
      </div>
      <div>
	    <h4>文章已同步更新公众号，欢迎关注</h4>
        <div class="wechat_appreciates">
          <img src="/images/wxgzh_qrcode.jpg" alt="qrcode" width="250" >
        </div>
      </div>
    </div>
  </center>
</section>



    
      <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = 'https://zhaozhiming.github.io/2018/05/06/expo-puth-notification-both-remote-and-local/';
            this.page.identifier = 'https://zhaozhiming.github.io/2018/05/06/expo-puth-notification-both-remote-and-local/';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//zhaozhiming.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

</div>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2025

    赵芝明
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a target="_blank" rel="noopener" href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a target="_blank" rel="noopener" href="http://github.com/panks/fabric">fabric</a> by <a target="_blank" rel="noopener" href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5608723650603289" crossorigin="anonymous"></script>
</body>
</html>
