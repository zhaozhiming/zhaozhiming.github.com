<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>使用 Filebeat 收集 Docker 容器日志 - Hacker and Geeker&#39;s Way</title>
    <meta name="author" content="">
    
	<meta name="description" content="使用 Filebeat 收集 Docker 容器日志"> <!-- TODO: truncate -->
	<meta name="keywords" content="filebeat,docker,elasticsearch,kibana">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="Hacker and Geeker&#39;s Way" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='/stylesheets/font.css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/font.css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/font.css?family=Amethysta+One' rel='stylesheet' type='text/css'>
	  <script src="/javascripts/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-100485541-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


<meta name="generator" content="Hexo 6.3.0"></head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Hacker and Geeker&#39;s Way
    </div>
</h1>
<span class="subtitle"></span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a target="_blank" rel="noopener" href="https://github.com/zhaozhiming" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a target="_blank" rel="noopener" href="http://www.twitter.com/kingzzm" class="twitter" title="Twitter"></a>
  </li>
  
  
  <!-- LinkedIn -->
  <li>
  <a target="_blank" rel="noopener" href="http://www.linkedin.com/in/zhaozhiming" class="linkedin" title="LinkedIn"></a>
  </li>
  
  
  
  
  
  <!-- Stackoverflow -->
  <li>
  <a target="_blank" rel="noopener" href="http://stackoverflow.com/users/1954315/zhaozhiming" class="stackoverflow" title="Stackoverflow"></a>
  </li>
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    <li><a href="/about/index.html">About</a></li>
    
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="https://zhaozhiming.github.io" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>


<div id="toload">
<!-- begin toload -->
    <div id="content">
        <div class="inner">
<article class="post">
	<h2 class="title">使用 Filebeat 收集 Docker 容器日志</h2>
    <div class="meta">
        <div class="date">Published on: <time datetime="2019-09-14T02:53:00.000Z" itemprop="datePublished">9月 14, 2019</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/docker/">docker</a> <a href="/tags/filebeat/">filebeat</a> <a href="/tags/elasticsearch/">elasticsearch</a> <a href="/tags/kibana/">kibana</a>
</div>
    </div>
	<div class="entry-content"><img src="/images/post/2019/09/log-collect.png" class="" width="400" height="300">

<p>问题：开发人员查看测试环境或者生产环境的日志非常不方便，因为我们服务都是用 Docker 部署的，所以开发人员需要先登录到服务器，然后再登录到某个 Docker 容器才能看到日志。</p>
<p>解决办法：搭建一套日志可视化环境，让开发人员可以通过浏览器直接查看系统各个服务的日志。下面介绍一下如何使用 Filebeat 来收集 Docker 容器日志，并将日志存入 Elasticsearch，再通过 Kibana 来展示。</p>
<span id="more"></span>

<h2 id="Filebeat-vs-LogStash"><a href="#Filebeat-vs-LogStash" class="headerlink" title="Filebeat vs. LogStash"></a>Filebeat vs. LogStash</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/products/beats/filebeat">Filebeat</a> 是<code>Elastic</code>公司的一个轻量型日志采集器，它可以用来代替该公司旗下的 <a target="_blank" rel="noopener" href="https://www.elastic.co/cn/products/logstash">Logstash</a>，也可以和 Logstash 配合一起使用。</p>
<p>Filebeat 和 LogStash 相比十分轻量，体积只有 30 多 M，占用的资源较低，安装也比较简单，可以在每个需要收集日志的服务器上部署运行。</p>
<p>Filebeat 将更多能力放在了数据<code>收集</code>上面，而 Logstash 更多的能力是体现在数据的<code>过滤</code>和<code>转换</code>上。</p>
<h2 id="EFK-安装"><a href="#EFK-安装" class="headerlink" title="EFK 安装"></a>EFK 安装</h2><p>ElasticSearch 和 Kibana 的安装比较简单，可以直接用 Docker 安装的方式，但要注意 Elasticsearch 和 Kibana 的版本需要保持一致，不然 Kibana 可能启动不起来。</p>
<p>Filebeat 的安装方式有多种，可以直接下载安装程序安装，也可以通过 Docker 方式安装，命令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name=filebeat \</span><br><span class="line">  --user=root \</span><br><span class="line">  --volume=<span class="string">&quot;<span class="subst">$(pwd)</span>/filebeat.docker.yml:/usr/share/filebeat/filebeat.yml:ro&quot;</span> \</span><br><span class="line">  --volume=<span class="string">&quot;/var/lib/docker/containers:/var/lib/docker/containers:ro&quot;</span> \</span><br><span class="line">  --volume=<span class="string">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span> \</span><br><span class="line">  docker.elastic.co/beats/filebeat:7.3.1 filebeat -e -strict.perms=<span class="literal">false</span> \</span><br><span class="line">  -E output.elasticsearch.hosts=[<span class="string">&quot;localhost:9200&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>注意这里映射了 Filebeat 配置文件的路径，同时映射了 Docker 容器的文件路径。</p>
<p>也可以使用 Docker-compose 来启动 Filebeat：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">filebeat:</span><br><span class="line">    image: docker.elastic.co/beats/filebeat:7.3.1</span><br><span class="line">    user: root</span><br><span class="line">    <span class="built_in">command</span>: filebeat -e -strict.perms=<span class="literal">false</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./filebeat/filebeat.docker.yml:/usr/share/filebeat/filebeat.yml:ro</span><br><span class="line">      - /var/lib/docker/containers:/var/lib/docker/containers:ro</span><br><span class="line">      - /var/run/docker.sock:/var/run/docker.sock:ro</span><br><span class="line">    restart: always</span><br><span class="line">    links:</span><br><span class="line">      - elasticsearch</span><br></pre></td></tr></table></figure>

<h2 id="基于-Docker-的-Filebeat-配置"><a href="#基于-Docker-的-Filebeat-配置" class="headerlink" title="基于 Docker 的 Filebeat 配置"></a>基于 Docker 的 Filebeat 配置</h2><p>使用官方推荐的这个配置模板就够了，我们对 Filebeat 的配置主要体现在具体的容器上，而不是 Filebeat 本身。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用这个命令下载 filebeat 配置文件</span></span><br><span class="line">curl -L -O https://raw.githubusercontent.com/elastic/beats/7.3/deploy/docker/filebeat.docker.yml</span><br></pre></td></tr></table></figure>

<p>配置文件内容是这样：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.config:</span></span><br><span class="line">  <span class="attr">modules:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">    <span class="attr">reload.enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">filebeat.autodiscover:</span></span><br><span class="line">  <span class="attr">providers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">docker</span></span><br><span class="line">      <span class="attr">hints.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">add_cloud_metadata:</span> <span class="string">~</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">&#x27;$&#123;ELASTICSEARCH_HOSTS:elasticsearch:9200&#125;&#x27;</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&#x27;$&#123;ELASTICSEARCH_USERNAME:&#125;&#x27;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&#x27;$&#123;ELASTICSEARCH_PASSWORD:&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="过滤不需要收集日志的-Docker-容器"><a href="#过滤不需要收集日志的-Docker-容器" class="headerlink" title="过滤不需要收集日志的 Docker 容器"></a>过滤不需要收集日志的 Docker 容器</h2><p>按照我们上面的方式启动 Filebeat 后，Filebeat 会自动收集机器上所有 Docker 容器的日志，包括 Elasticsearch，Kibana，Filebeat 这些工具容器的日志，但这些日志可能不是我们所关心的，我们不想让 Filebeat 收集这些容器的日志。</p>
<p>Filebeat 提供了一些 Docker 标签（Label），可以让 Docker 容器在 Filebeat 的<code>autodiscover</code>阶段对日志进行过滤和加工，其中有个标签就是可以让某个容器的日志不进入 Filebeat：</p>
<ul>
<li>co.elastic.logs&#x2F;enabled: 日志收集功能是否启动标志，默认值为<code>true</code>，设为<code>false</code>即为不收集日志。</li>
</ul>
<p>可以在<code>docker run</code>的时候加上这个参数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --label co.elastic.logs/enabled=<span class="literal">false</span> ...</span><br></pre></td></tr></table></figure>

<p>如果你是用 Docker-compose 启动的话，可以这样写：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/beats/filebeat:7.3.1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">co.elastic.logs/enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>当然更好的方法是在 Filebeat 的配置文件里面配置需要收集日志的容器，但试了几次没找到可以让配置生效的写法，如果有人知道如何配置，也请留言告知，谢谢。</p>
<h2 id="统一收集容器中其他路径的日志"><a href="#统一收集容器中其他路径的日志" class="headerlink" title="统一收集容器中其他路径的日志"></a>统一收集容器中其他路径的日志</h2><p>Filebeat 默认收集的是 Docker 容器启动后输出到<code>docker logs</code>的日志，但有些服务除了这些日志外，还会把其他日志存放到容器的里面。比如<code>egg.js</code>框架会把错误日志和一些 web 日志放到<code>/root/logs/yourserver/</code>下面。那么要如何收集这些额外的日志呢？</p>
<p>解决方法是把额外日志的路径映射到 Docker 的输出控制台，我们可以在 Dockerfile 里面这样设置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将普通日志输出到 stdout</span></span><br><span class="line">RUN <span class="built_in">ln</span> -sf /dev/stdout /root/logs/web-server/web-server-web.log</span><br><span class="line"><span class="comment"># 将错误日志输出到 stderr</span></span><br><span class="line">RUN <span class="built_in">ln</span> -sf /dev/stderr /root/logs/web-server/common-error.log</span><br></pre></td></tr></table></figure>

<p>这样容器启动后就会将容器里日志传输到控制台上，而 Filebeat 也就可以收集该日志了。</p>
<h2 id="解决多行日志问题"><a href="#解决多行日志问题" class="headerlink" title="解决多行日志问题"></a>解决多行日志问题</h2><p>Filebeat 收集日志后将其存入到 Elasticsearch，默认的存储规则是一行日志作为 Elasticsearch 的一条记录，但像错误信息这种日志会出现多行的情况，如果同一个日志分成多行的话查看起来就不太方便，因为中间可能被其他日志打断，而且搜索的时候也不能把同一个错误的日志一并查询出来，所以最好的方式是能将同一个错误的多行日志存入 Elasticsearch 的同一条记录。</p>
<p>Filebeat 考虑到了这种情况，让我们可以通过添加容器便签的方式来设置多行日志的整合规则，比如我们的每条日志都是以时间格式开始的：<code>2019-01-01 11:11:11,1111 xxxx</code>，那么我们的多行设置规则就可以这样写：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">web-server-dev:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">co.elastic.logs/multiline.pattern:</span> <span class="string">&#x27;^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;\s\d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;,\d&#123;3&#125;\s&#x27;</span></span><br><span class="line">      <span class="attr">co.elastic.logs/multiline.negate:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">co.elastic.logs/multiline.match:</span> <span class="string">after</span></span><br></pre></td></tr></table></figure>

<p>其中 pattern 表示日志内容如果不匹配这个正则表达式则不能作为新的一行日志，这样日志就会按照时间进行分组了。</p>
<h2 id="Kibana-建立对应服务的搜索"><a href="#Kibana-建立对应服务的搜索" class="headerlink" title="Kibana 建立对应服务的搜索"></a>Kibana 建立对应服务的搜索</h2><p>Filebeat 将日志存入到 Elasticsearch 后，我们就可以通过 Kibana 来查看日志了。在 Kibana 中创建以<code>filebeat-*</code>开头的索引，表示查询以<code>filebeat</code>开头的索引，这是 Filebeat 导入日志的索引，每天会产生这样的一个索引。</p>
<p>创建完索引后可以通过一些 Docker 的查询条件来查询日志，比如想查询容器名为<code>foo</code>的容器的日志，就可以用<code>container.name=foo</code>这样的过滤条件来查询，如果想以镜像名来查询也可以，用<code>image.name=xxx</code>的查询条件就可以查询出该镜像的所有容器的日志。</p>
<p>展示字段一般只需要<code>message</code>字段就可以了，也可以视情况添加<code>container.name</code>或<code>image.name</code>等字段。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面介绍的 Filebeat 官方推荐的一种收集 Docker 容器的方法，其实还有其他方案，比如说在每个容器里面安装一个 Filebeat 客户端来分别收集各自服务的日志，或者是把每个 Docker 容器的日志路径都映射到宿主机上的某个目录下面，然后在宿主机上安装一个 Filebeat 客户端来统一收集。如果您还有更好的方案，希望可以留言一起讨论分享，谢谢。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/logging/">访问 Docker 容器日志</a></li>
</ul>
</div>

</article>
<section id="appreciates">
  <center>
	<h2>赞赏</h2>
    <div class="post-footer">
      <div>
	    <h4>如果文章对您有所帮助，可以捐赠我喝杯咖啡😌，捐赠方式：</h4>
        <div class="digital-wallet">
          <h6>BTC 地址：3LYgSyf7ddMALwGWPQr3PY4wzjsTDdg1oV</h6>
          <h6>ETH 地址：0x0C9b27c89A61aadb0aEC24CA8949910Cbf77Aa73</h6>
        </div>
        <div class="wechat_appreciates">
          <img src="/images/wechat_appreciates.png" alt="qrcode" width="250" >
        </div>
      </div>
      <div>
	    <h4>文章已同步更新公众号，欢迎关注</h4>
        <div class="wechat_appreciates">
          <img src="/images/wxgzh_qrcode.jpg" alt="qrcode" width="250" >
        </div>
      </div>
    </div>
  </center>
</section>



    
      <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = 'https://zhaozhiming.github.io/2019/09/14/use-filebeat-to-collect-docker-container-log/';
            this.page.identifier = 'https://zhaozhiming.github.io/2019/09/14/use-filebeat-to-collect-docker-container-log/';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//zhaozhiming.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

</div>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2025

    赵芝明
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a target="_blank" rel="noopener" href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a target="_blank" rel="noopener" href="http://github.com/panks/fabric">fabric</a> by <a target="_blank" rel="noopener" href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5608723650603289" crossorigin="anonymous"></script>
</body>
</html>
